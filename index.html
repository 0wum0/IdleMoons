<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Moons V8.9c - Settings & Particles - Weiter Angepasste Kosten</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Animated Star Background --- */
        @keyframes moveStars {
            from { background-position-y: 0px; }
            to { background-position-y: -10000px; } /* Großer Wert für langsames Scrollen */
        }

        body {
            font-family: 'Inter', sans-serif;
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
            background-color: #1f2937; /* bg-gray-800 - Basis-Hintergrundfarbe */
            color: #e5e7eb; /* text-gray-200 */
            overflow-x: hidden; /* Verhindert horizontales Scrollen */
            min-height: 100vh; /* Stellt sicher, dass der Body mindestens die Höhe des Viewports hat */

            /* --- Sternenhintergrund-Ebenen --- */
            background-image:
                radial-gradient(1px 1px at 50px 150px, #fff, rgba(255,255,255,0)),
                radial-gradient(1px 1px at 100px 250px, #ddd, rgba(255,255,255,0)),
                radial-gradient(1px 1px at 200px 50px, #eee, rgba(255,255,255,0)),
                radial-gradient(2px 2px at 300px 300px, #fff, rgba(255,255,255,0)),
                radial-gradient(2px 2px at 450px 100px, #ddd, rgba(255,255,255,0)),
                radial-gradient(3px 3px at 600px 400px, #fff, rgba(255,255,255,0));
            background-repeat: repeat;
            background-size: 300px 300px, 400px 400px, 350px 350px, 500px 500px, 600px 600px, 800px 800px;
            animation: moveStars 200s linear infinite, moveStars 200s linear infinite, moveStars 200s linear infinite, moveStars 150s linear infinite, moveStars 150s linear infinite, moveStars 100s linear infinite;
            background-attachment: fixed;
        }

        /* --- Click Particles --- */
        .particle {
            position: absolute;
            width: 6px; /* Etwas größer */
            height: 6px;
            background-color: #fde047; /* Gelb/Gold-Farbe */
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            opacity: 1;
            /* Use custom properties set by JS for destination */
            animation: particle-fade-out 0.7s ease-out forwards;
        }
        @keyframes particle-fade-out {
            to {
                transform: translate(var(--translateX, 0), var(--translateY, -50px)) scale(0.3); /* Ziel und Verkleinerung */
                opacity: 0;
            }
        }
        /* General Button Styling */
        button {
            transition: all 150ms ease-in-out;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid transparent; /* Default border */
        }
        button:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px); /* Leichtes Anheben */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Größerer Schatten */
        }
        button:active:not(:disabled) {
            transform: scale(0.97) translateY(0px); /* Reset Anheben beim Klick */
            filter: brightness(0.95);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(0); /* Kein Anheben für disabled */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Normaler Schatten */
        }
        /* Hervorhebung für kaufbare Buttons */
        button.affordable-highlight {
            border-color: #4ade80; /* green-400 */
            box-shadow: 0 0 8px rgba(74, 222, 128, 0.6);
        }
        button.affordable-highlight:hover:not(:disabled) {
            box-shadow: 0 0 12px rgba(74, 222, 128, 0.8), 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* --- Header Layout --- */
        .game-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background-color: rgba(55, 65, 81, 0.8); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-title { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #818cf8; margin: 0; }
        .header-resources { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; flex-grow: 1; margin: 0.5rem 0; padding: 0 1rem; text-align: center; }
        @media (min-width: 768px) { .header-resources { grid-template-columns: repeat(4, minmax(0, 1fr)); margin: 0; } }
        .header-resources > div { padding: 0.25rem; background-color: rgba(75, 85, 99, 0.6); border-radius: 0.375rem; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
        .header-resources p:first-child { font-size: 0.75rem; color: #d1d5db; margin-bottom: 0.1rem; }
        .header-resources .resource-amount-display { font-size: 1rem; font-weight: 700; line-height: 1.1; margin-top: 0; margin-bottom: 0;}
        .capacity-display { font-size: 0.65rem; color: #9ca3af; line-height: 1; margin-top: 0; margin-bottom: 0.2rem;}
        .resource-progress-bar-container { margin-top: auto; margin-bottom: 0.1rem; background-color: rgba(75, 85, 99, 0.7); border-radius: 0.25rem; overflow: hidden; height: 0.375rem; }
        .header-resources .rate-display { font-size: 0.75rem; color: #9ca3af; margin-top: 0.1rem; }
        .header-right { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        #notification-button.active { color: #f87171; animation: ringBell 1.5s ease-in-out infinite; }
        @keyframes ringBell { 0%, 100% { transform: rotate(0); } 10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); } 20%, 40%, 60%, 80% { transform: rotate(10deg); } }
        /* Resource Progress Bar */
        .resource-progress-bar { height: 100%; transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out; }
        .resource-progress-bar-dust { background-color: #f59e0b; }
        .resource-progress-bar-energy { background-color: #22d3ee; }
        .resource-progress-bar-energy.low { background-color: #ef4444; }
        .resource-progress-bar-metal { background-color: #94a3b8; }
        .resource-progress-bar-population { background-color: #4ade80; }
        .resource-progress-bar.warning { background-color: #f97316; }

        /* Burger Menu */
        #burger-button { z-index: 60; background-color: rgba(75, 85, 99, 0.8); color: white; padding: 0.5rem; border-radius: 0.375rem; border: none; flex-shrink: 0; }
        #burger-menu-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 55; opacity: 0; transition: opacity 300ms ease-in-out; pointer-events: none; }
        #burger-menu-overlay.active { opacity: 1; pointer-events: auto; }
        #burger-menu { position: fixed; top: 0; left: 0; bottom: 0; width: 250px; max-width: 80%; background-color: rgba(55, 65, 81, 0.95); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); padding: 1.5rem; box-shadow: 0 0 15px rgba(0,0,0,0.3); transform: translateX(-100%); transition: transform 300ms ease-in-out; z-index: 60; overflow-y: auto; }
        #burger-menu.active { transform: translateX(0); }
        .menu-item { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; margin-bottom: 0.5rem; background-color: #4b5563; color: #d1d5db; border: none; }
        .menu-item.active { background-color: #4f46e5; color: white; font-weight: 600; }

        /* Tab Content */
        .tab-content { display: none; animation: fadeInContent 0.5s ease-out forwards; }
        .tab-content.active { display: block; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Anpassung Hauptcontainer --- */
        .main-content-container {
             background-color: rgba(31, 41, 55, 0.85);
             backdrop-filter: blur(4px);
             -webkit-backdrop-filter: blur(4px);
             padding: 1.5rem;
             border-radius: 0.75rem;
             box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
             width: 100%;
             max-width: 48rem;
             text-align: center;
             margin-top: 1rem;
         }
         @media (min-width: 768px) {
             .main-content-container {
                 padding: 2rem;
             }
         }
         /* Toasts */
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
        .toast { padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2); color: white; font-size: 0.875rem; max-width: 300px; opacity: 0; animation: toastEnter 0.5s ease-out forwards; position: relative; background-color: rgba(31, 41, 55, 0.8); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
        .toast.toast-info { border-left: 4px solid #0e7490; } .toast.toast-threat { border-left: 4px solid #b91c1c; } .toast.toast-success { border-left: 4px solid #15803d; } .toast.toast-warning { border-left: 4px solid #b45309; }
        @keyframes toastEnter { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastExit { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .toast.exiting { animation: toastExit 0.5s ease-in forwards; }
        .toast-close-button { position: absolute; top: 0.25rem; right: 0.5rem; background: none; border: none; color: rgba(255,255,255,0.7); font-size: 1.25rem; line-height: 1; cursor: pointer; padding: 0; box-shadow: none; }
        .toast-close-button:hover { color: white; }

        /* Animations & General Styles */
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } } .pulse-once { animation: pulse 0.3s ease-in-out; }
        .resource-value { transition: color 0.2s ease-in-out, transform 0.2s ease-in-out; } .resource-value.updated { color: #6ee7b7; transform: scale(1.05); }
        @keyframes flash-bg { 0% { background-color: inherit; } 50% { background-color: rgba(255, 255, 255, 0.2); } 100% { background-color: inherit; } } .flash-upgrade { animation: flash-bg 0.4s ease-out; }
        .num { font-weight: bold; }
        .upgrade-card, .research-card, .trade-card, .shipyard-card { background-color: rgba(55, 65, 81, 0.85); padding: 0.75rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 0.5rem; }
        @media (min-width: 640px) { .upgrade-card, .research-card, .trade-card, .shipyard-card { flex-direction: row; align-items: center; } .upgrade-card > div:first-child, .research-card > div:first-child, .trade-card > div:first-child, .shipyard-card > div:first-child { flex-grow: 1; } .upgrade-card > button, .research-card > button, .trade-card > button, .shipyard-card > button { width: auto; margin-top: 0; } }

        /* Progress Bars (Inner) */
        .progress-bar-container { background-color: rgba(75, 85, 99, 0.7); border-radius: 0.375rem; overflow: hidden; height: 1.25rem; margin-top: 0.25rem; margin-bottom: 0.5rem;}
        .progress-bar { height: 100%; transition: width 0.4s ease-in-out; text-align: center; color: rgba(255, 255, 255, 0.9); font-size: 0.75rem; line-height: 1.25rem; font-weight: 500; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        .progress-bar-threat { background-color: #ef4444; } .progress-bar-prestige { background-color: #f59e0b; } .progress-bar-population { background-color: #16a34a; } .progress-bar-fields { background-color: #ca8a04; }
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; transition: opacity 300ms ease-in-out; pointer-events: none; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: rgba(31, 41, 55, 0.95); padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; transform: scale(0.95); transition: transform 300ms ease-in-out; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        #admin-password-input { background-color: #374151; color: #e5e7eb; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        #changelog-modal-content .changelog { margin-top: 0; padding-top: 0; border-top: none; font-size: 0.875rem; }
        #changelog-modal-content .changelog h5 { display: none; } #changelog-modal-content .changelog ul { padding-left: 1rem; }

        /* Footer */
        .game-footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #4b5563; text-align: center; font-size: 0.875rem; color: #9ca3af; }
        .game-footer a { color: #a5b4fc; text-decoration: underline; transition: color 150ms ease-in-out; }
        .game-footer a:hover { color: #c7d2fe; }

        /* Planet Graphics */
        .planet-graphic { width: 150px; height: 150px; border-radius: 50%; margin: 1rem auto; background-color: rgba(75, 85, 99, 0.7); display: flex; align-items: center; justify-content: center; font-size: 3rem; border: 3px solid #6b7280; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        .planet-graphic.moon { background: linear-gradient(145deg, #e0e0e0, #a0a0a0); border-color: #c0c0c0; color: #4b5563; }
        .planet-graphic.mars { background: linear-gradient(145deg, #e89a76, #c75e3a); border-color: #d77e5a; color: #fef3c7; }
        .planet-graphic.venus { background: linear-gradient(145deg, #fef3c7, #fde68a); border-color: #facc15; color: #78350f; }
        .planet-graphic.jupiter { background: linear-gradient(145deg, #f3d9b1, #d5a770); border-color: #e1b98a; color: #4b5563; }

        /* Shake Animation */
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; transform: translate3d(0, 0, 0); backface-visibility: hidden; perspective: 1000px; }

         /* Spezielle Styles für Tab-Container */
        .stats-tab-content, .prestige-tab-content, .leaderboard-tab-content, .settings-tab-content {
             background-color: rgba(55, 65, 81, 0.8); /* bg-gray-800 mit Transparenz */
             padding: 1rem;
             border-radius: 0.5rem; /* rounded-lg */
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
         }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4"> <header class="game-header w-full max-w-3xl">
         <div class="header-left">
              <button id="burger-button" title="Menü öffnen">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
              </button>
              <h1 class="header-title">Idle Moons</h1>
         </div>
         <div class="header-resources">
              <div id="header-dust" title="Mondstaub: 0">
                  <p>🌙 Mondstaub:</p>
                  <p id="resource-count" class="resource-amount-display resource-value text-yellow-400">0</p>
                  <p id="resource-capacity" class="capacity-display">Max: 0</p>
                  <div class="resource-progress-bar-container">
                      <div id="resource-bar-dust" class="resource-progress-bar resource-progress-bar-dust" style="width: 0%;"></div>
                  </div>
                  <p id="resource-rate" class="rate-display"><span class="num">0</span>/s</p>
              </div>
              <div id="header-energy" title="Energie: 0">
                  <p>⚡ Energie:</p>
                  <p id="energy-count" class="resource-amount-display resource-value text-cyan-400">0</p>
                  <p id="energy-capacity" class="capacity-display">Max: 0</p>
                  <div class="resource-progress-bar-container">
                      <div id="resource-bar-energy" class="resource-progress-bar resource-progress-bar-energy" style="width: 0%;"></div>
                  </div>
                  <p id="energy-rate" class="rate-display"><span class="num">0</span>/s</p>
              </div>
               <div id="header-metal" title="Metall: 0">
                  <p>🔩 Metall:</p>
                  <p id="metal-count" class="resource-amount-display resource-value text-slate-400">0</p>
                  <p id="metal-capacity" class="capacity-display">Max: 0</p>
                  <div class="resource-progress-bar-container">
                      <div id="resource-bar-metal" class="resource-progress-bar resource-progress-bar-metal" style="width: 0%;"></div>
                  </div>
                  <p id="metal-rate" class="rate-display"><span class="num">0</span>/s</p>
              </div>
               <div id="header-population" title="Bevölkerung: 0">
                  <p>👨‍👩‍👧‍👦 Bevölkerung:</p>
                  <p id="population-count" class="resource-amount-display resource-value text-green-400">0</p>
                  <p id="population-capacity" class="capacity-display">Max: 0</p>
                  <div class="resource-progress-bar-container">
                      <div id="resource-bar-population" class="resource-progress-bar resource-progress-bar-population" style="width: 0%;"></div>
                  </div>
                  <p id="population-rate" class="rate-display"><span class="num">0</span>/s</p>
              </div>
         </div>
         <div class="header-right">
               <button id="notification-button" title="Benachrichtigungen" class="text-gray-400 hover:text-white p-1 rounded transition">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
               </button>
         </div>
    </header>
    <div id="burger-menu-overlay"></div>
    <div id="burger-menu" class="space-y-2">
        <h2 class="text-xl font-semibold text-indigo-300 mb-4">Navigation</h2>
        <button class="menu-item active" data-tab="overview">Übersicht</button>
        <button class="menu-item" data-tab="build-menu">Baumenü</button>
        <button class="menu-item" data-tab="defense">Verteidigung</button>
        <button class="menu-item" data-tab="shipyard">Werft</button>
        <button class="menu-item" data-tab="research">Forschung</button>
        <button class="menu-item" data-tab="planets">Planeten</button>
        <button class="menu-item" data-tab="trade">Handel</button>
        <button class="menu-item" data-tab="stats">Statistiken</button>
        <button class="menu-item" data-tab="prestige">Prestige</button>
        <button class="menu-item" data-tab="leaderboard">Rangliste</button>
        <button class="menu-item" data-tab="settings">Einstellungen</button> </div>

    <div class="main-content-container">
        <div class="text-center mb-4">
             <p id="prestige-bonus-display" class="text-sm text-green-400 mt-1 hidden">Kristall-Bonus: +<span id="prestige-bonus-percent">0</span>% Produktion</p>
             <p id="colony-bonus-display" class="text-sm text-orange-400 mt-1 hidden">Kolonie-Bonus: +<span id="colony-bonus-percent">0</span>% Produktion</p>
        </div>
        <button id="manual-collect-button" title="Sammelt 1 Mondstaub" class="w-full bg-gradient-to-br from-yellow-400 to-amber-500 hover:from-yellow-500 hover:to-amber-600 text-gray-900 font-bold py-3 px-4 rounded-lg mb-6 shadow-lg">
            Mondstaub sammeln 🌙 (+<span id="manual-collect-amount" class="num">1</span>)
        </button>

        <div id="tab-content-container" class="mt-4">
            <div id="overview-tab" class="tab-content active space-y-4">
                <h3 class="text-xl font-semibold mb-3 text-indigo-300">Übersicht: <span id="current-location-name">Mond</span></h3>
                <div id="location-graphic" class="planet-graphic moon"><span>🌙</span></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                     <div>
                         <p>Bebaute Felder: <span id="overview-fields-current">0</span> / <span id="overview-fields-max">10</span></p>
                         <div class="progress-bar-container"><div id="overview-fields-bar" class="progress-bar progress-bar-fields" style="width: 0%;"></div></div>
                     </div>
                     <div>
                         <p>Bevölkerungskapazität: <span id="overview-population-current">0</span> / <span id="overview-population-max">0</span></p>
                         <div class="progress-bar-container"><div id="overview-population-bar" class="progress-bar progress-bar-population" style="width: 0%;"></div></div>
                     </div>
                 </div>
                 <div class="text-left bg-gray-800 p-4 rounded-lg shadow-inner mt-6" style="background-color: rgba(55, 65, 81, 0.8);"> <h4 class="text-lg font-semibold mb-2 text-indigo-300">Spielanleitung</h4>
                     <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                         <li>Sammle 🌙 Mondstaub manuell oder durch automatische Gebäude (bis zum Kapazitätslimit).</li>
                         <li>Investiere Ressourcen im "Baumenü", um deine Produktion und Kapazitäten zu steigern.</li>
                         <li>Baue 📦 Lagersilos, um mehr 🌙 Staub und 🔩 Metall zu speichern.</li>
                         <li>Erzeuge ⚡ Energie und 🔩 Metall für fortgeschrittene Gebäude und Schiffe.</li>
                         <li>Erhöhe deine 👨‍👩‍👧‍👦 Bevölkerung durch Wohnmodule (kostet 🔩 Metall, benötigt Platz).</li>
                         <li>Baue Verteidigungsanlagen (⚡ Energie), um Bedrohungen abzuwehren.</li>
                         <li>Erforsche 🔬 neue Technologien für Boni und Freischaltungen.</li>
                         <li>Kolonisiere Planeten 🪐 für globale Produktionsboni.</li>
                         <li>Baue Schiffe 🚀 in der Werft (benötigt Forschung).</li>
                         <li>Nutze den Handelsposten 📉📈, um Ressourcen zu tauschen.</li>
                         <li>Erreiche hohe Mondstaub-Mengen, um Prestige ✨ auszulösen und permanente Boni (Kristalle) zu erhalten.</li>
                         <li>Unter "Einstellungen" kannst du manuell speichern/laden.</li> </ul>
                 </div>
            </div>
            <div id="build-menu-tab" class="tab-content space-y-3">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-300">Baumenü 🏗️</h3>
                 <h4 class="text-lg font-semibold mb-2 text-gray-300">Produktion (Mondstaub 🌙)</h4>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Autom. Sammler</p><p class="text-xs text-gray-400">Staub/Sek: +<span id="collector-increase" class="num">1</span> | Lvl: <span id="collector-level" class="num">0</span></p></div><button id="upgrade-collector" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">10</span> 🌙</button></div>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Mond-Rover</p><p class="text-xs text-gray-400">Staub/Sek: +<span id="rover-increase" class="num">10</span> | Lvl: <span id="rover-level" class="num">0</span></p></div><button id="upgrade-rover" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">250</span> 🌙</button></div>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Produktions-Effizienz</p><p class="text-xs text-gray-400">Verdoppelt Staub/Sek | Lvl: <span id="efficiency-level" class="num">0</span></p></div><button id="upgrade-efficiency" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">100</span> 🌙</button></div>
                 <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-300">Klick-Verbesserungen (Mondstaub 🌙)</h4>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Klick-Kraft</p><p class="text-xs text-gray-400">Staub/Klick: +<span id="click-power-increase" class="num">1</span> | Lvl: <span id="click-power-level" class="num">0</span></p></div><button id="upgrade-click-power" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">25</span> 🌙</button></div>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Klick-Multiplikator</p><p class="text-xs text-gray-400">Multipliziert Klick (x<span id="click-multiplier-value" class="num">1</span>) | Lvl: <span id="click-multiplier-level" class="num">0</span></p></div><button id="upgrade-click-multiplier" class="bg-pink-600 hover:bg-pink-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">500</span> 🌙</button></div>
                 <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-300">Energieproduktion (⚡)</h4>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Energiegenerator</p><p class="text-xs text-gray-400">Energie/Sek: +<span id="generator-increase" class="num">1</span> | Lvl: <span id="generator-level" class="num">0</span></p></div><button id="upgrade-generator" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">800</span> 🌙</button></div> <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Energiespeicher</p><p class="text-xs text-gray-400">Max. Energie: +<span id="storage-increase" class="num">500</span> | Lvl: <span id="storage-level" class="num">0</span></p></div><button id="upgrade-storage" class="bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">200</span> 🔩</button></div> <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-300">Metallproduktion (🔩)</h4>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Asteroiden-Bergbau</p><p class="text-xs text-gray-400">Metall/Sek: +<span id="mining-increase" class="num">1</span> | Lvl: <span idv="mining-level" class="num">0</span></p></div><button id="upgrade-mining" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">400</span> 🌙</button></div>
                 <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-300">Bevölkerungswachstum (👨‍👩‍👧‍👦)</h4>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Wohnmodule</p><p class="text-xs text-gray-400">Bev./Sek: +<span id="housing-increase" class="num">0.1</span> | Kapazität: +10 | Lvl: <span id="housing-level" class="num">0</span></p></div><button id="upgrade-housing" class="bg-lime-600 hover:bg-lime-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">100</span> 🔩</button></div>
                 <h4 class="text-lg font-semibold mb-2 mt-4 text-gray-300">Lagerkapazität 📦</h4>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Lagersilos</p><p class="text-xs text-gray-400"> Max. Staub: +<span id="silo-dust-increase" class="num">0</span> | Max. Metall: +<span id="silo-metal-increase" class="num">0</span> | Lvl: <span id="silo-level" class="num">0</span></p></div><button id="upgrade-silo" class="bg-orange-600 hover:bg-orange-700 text-white text-sm font-bold py-2 px-3"> Kosten: <span id="silo-cost-dust" class="num">0</span> 🌙, <span id="silo-cost-metal" class="num">0</span> 🔩</button></div> </div>
            <div id="defense-tab" class="tab-content space-y-3">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-300">Verteidigungsanlagen (⚡)</h3>
                 <p class="text-sm text-gray-400 mb-4">Baue Verteidigungsanlagen mit Energie ⚡.</p>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Schildgenerator</p><p class="text-xs text-gray-400">Reduziert Abwehrkosten um <span id="shield-effect" class="num">0</span>% | Lvl: <span id="shield-level" class="num">0</span></p></div><button id="upgrade-shield" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">50</span> ⚡</button></div>
                 <div class="upgrade-card"><div class="text-left"><p class="font-semibold">Abwehrturm</p><p class="text-xs text-gray-400">Verursacht <span id="turret-damage" class="num">0</span> Schaden/Sek | Lvl: <span id="turret-level" class="num">0</span></p></div><button id="upgrade-turret" class="bg-rose-600 hover:bg-rose-700 text-white text-sm font-bold py-2 px-3">Kosten: <span class="num">100</span> ⚡</button></div>
            </div>
            <div id="shipyard-tab" class="tab-content space-y-3">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-300">Raumschiffswerft 🏭</h3>
                 <p class="text-sm text-gray-400 mb-4">Baue Schiffe, nachdem du die entsprechende Forschung abgeschlossen hast.</p>
                 <div id="shipyard-transport" class="shipyard-card hidden"><div class="text-left"><p class="font-semibold">Transporter 🚚</p><p class="text-xs text-gray-400">Transportiert Güter (zukünftige Funktion).</p><p class="text-xs text-gray-400">Anzahl: <span id="ship-count-transport" class="num">0</span></p></div><button id="build-transport" class="bg-orange-600 hover:bg-orange-700 text-white text-sm font-bold py-2 px-3"> Bauen (Kosten: <span id="build-cost-transport" class="num">1k</span> 🔩)</button></div>
                 <p id="shipyard-transport-locked" class="text-sm text-gray-500">Forschung "Frachtraumtechnologie" benötigt.</p>
                 <div id="shipyard-fighter" class="shipyard-card hidden"><div class="text-left"><p class="font-semibold">Jäger 🚀</p><p class="text-xs text-gray-400">Unterstützt die Verteidigung (zukünftige Funktion).</p><p class="text-xs text-gray-400">Anzahl: <span id="ship-count-fighter" class="num">0</span></p></div><button id="build-fighter" class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-3"> Bauen (Kosten: <span id="build-cost-fighter" class="num">500</span> 🔩, <span id="build-cost-fighter-energy" class="num">1k</span> ⚡)</button></div>
                 <p id="shipyard-fighter-locked" class="text-sm text-gray-500">Forschung "Antriebssysteme" benötigt.</p>
                 <div id="shipyard-colony" class="shipyard-card hidden"><div class="text-left"><p class="font-semibold">Kolonieschiff 🛰️</p><p class="text-xs text-gray-400">Ermöglicht die Kolonisierung neuer Planeten.</p><p class="text-xs text-gray-400">Anzahl: <span id="ship-count-colony" class="num">0</span></p></div><button id="build-colony" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-3"> Bauen (Kosten: <span id="build-cost-colony" class="num">10k</span> 🔩, <span id="build-cost-colony-energy" class="num">5k</span> ⚡)</button></div>
                 <p id="shipyard-colony-locked" class="text-sm text-gray-500">Forschung "Kolonisationstechnologie" benötigt.</p>
            </div>
            <div id="research-tab" class="tab-content space-y-3">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-300">Forschung 🔬</h3>
                 <p class="text-sm text-gray-400 mb-4">Schalte permanente Boni und neue Technologien frei.</p>
                 <div id="research-collector-efficiency" class="research-card"><div class="text-left"><p class="font-semibold">Verbesserte Sammler</p><p class="text-xs text-gray-400">Erhöht die Basisproduktion von Sammlern und Rovern um +10%.</p><p class="text-xs text-gray-400">Status: <span id="research-collector-status">Nicht erforscht</span></p></div><button id="research-collector-button" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3"> Erforschen (Kosten: <span id="research-collector-cost" class="num">10k</span> 🌙)</button></div>
                 <div id="research-energy-efficiency" class="research-card"><div class="text-left"><p class="font-semibold">Energieeffizienz</p><p class="text-xs text-gray-400">Reduziert die Energiekosten von Verteidigungsanlagen um 5%.</p> <p class="text-xs text-gray-400">Status: <span id="research-energy-status">Nicht erforscht</span></p></div><button id="research-energy-button" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3"> Erforschen (Kosten: <span id="research-energy-cost" class="num">5k</span> ⚡)</button></div>
                 <div id="research-cargo-tech" class="research-card"><div class="text-left"><p class="font-semibold">Frachtraumtechnologie</p><p class="text-xs text-gray-400">Schaltet den Bau von Transportern frei.</p> <p class="text-xs text-gray-400">Status: <span id="research-cargo-status">Nicht erforscht</span></p></div><button id="research-cargo-button" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3"> Erforschen (Kosten: <span id="research-cargo-cost" class="num">25k</span> 🌙, <span id="research-cargo-cost-metal" class="num">1k</span> 🔩)</button></div>
                 <div id="research-propulsion-tech" class="research-card"><div class="text-left"><p class="font-semibold">Antriebssysteme</p><p class="text-xs text-gray-400">Schaltet den Bau von Jägern frei.</p> <p class="text-xs text-gray-400">Status: <span id="research-propulsion-status">Nicht erforscht</span></p></div><button id="research-propulsion-button" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3"> Erforschen (Kosten: <span id="research-propulsion-cost" class="num">50k</span> 🌙, <span id="research-propulsion-cost-energy" class="num">2k</span> ⚡)</button></div>
                 <div id="research-colonization-tech" class="research-card"><div class="text-left"><p class="font-semibold">Kolonisationstechnologie</p><p class="text-xs text-gray-400">Schaltet den Bau von Kolonieschiffen frei.</p> <p class="text-xs text-gray-400">Status: <span id="research-colonization-status">Nicht erforscht</span></p></div><button id="research-colonization-button" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3"> Erforschen (Kosten: <span id="research-colonization-cost" class="num">100k</span> 🌙, <span id="research-colonization-cost-metal" class="num">5k</span> 🔩)</button></div>
            </div>
            <div id="planets-tab" class="tab-content space-y-3">
                <h3 class="text-xl font-semibold mb-3 text-indigo-300">Planeten Kolonisieren</h3>
                <p class="text-sm text-gray-400 mb-4">Erweitere dein Imperium. Jede Kolonie gibt +1% globale Mondstaub-Produktion.</p>
                <div id="planet-list" class="space-y-3"></div>
            </div>
            <div id="trade-tab" class="tab-content space-y-3">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-300">Handelsposten 📉📈</h3>
                 <p class="text-sm text-gray-400 mb-4">Tausche Ressourcen zu festen Kursen (beachte Kapazitäten).</p>
                 <div class="trade-card"><div class="text-left"><p class="font-semibold">Energie kaufen</p><p class="text-xs text-gray-400">Tausche 1K 🌙 gegen 100 ⚡</p></div><button id="trade-dust-for-energy" class="bg-cyan-700 hover:bg-cyan-800 text-white text-sm font-bold py-2 px-3"> Tauschen</button></div>
                 <div class="trade-card"><div class="text-left"><p class="font-semibold">Metall kaufen</p><p class="text-xs text-gray-400">Tausche 500 ⚡ gegen 50 🔩</p></div><button id="trade-energy-for-metal" class="bg-slate-700 hover:bg-slate-800 text-white text-sm font-bold py-2 px-3"> Tauschen</button></div>
            </div>
             <div id="stats-tab" class="tab-content space-y-2 text-left stats-tab-content"> <h3 class="text-xl font-semibold mb-3 text-indigo-300 text-center">Statistiken</h3>
                 <p>Gesamter gesammelter Mondstaub 🌙: <span id="stat-total-resources" class="num float-right">0</span></p>
                 <p>Gesamte Energie erzeugt ⚡: <span id="stat-total-energy" class="num float-right">0</span></p>
                 <p>Gesamtes Metall gefördert 🔩: <span id="stat-total-metal" class="num float-right">0</span></p>
                 <p>Aktuelle Bevölkerung 👨‍👩‍👧‍👦: <span id="stat-population" class="num float-right">0</span></p>
                 <p>Anzahl Transporter 🚚: <span id="stat-ship-transport" class="num float-right">0</span></p>
                 <p>Anzahl Jäger 🚀: <span id="stat-ship-fighter" class="num float-right">0</span></p>
                 <p>Anzahl Kolonieschiffe 🛰️: <span id="stat-ship-colony" class="num float-right">0</span></p>
                 <p>Gesamte manuelle Klicks: <span id="stat-total-clicks" class="num float-right">0</span></p>
                 <p>Abgewehrte Bedrohungen: <span id="stat-threats-defeated" class="num float-right">0</span></p>
                 <p>Spielzeit (seit letztem Reset): <span id="stat-play-time" class="num float-right">0s</span></p>
                 <p>Mondkristalle ✨: <span id="stat-moon-crystals" class="num float-right">0</span></p>
                 <p>Kolonisierte Planeten: <span id="stat-colonized-planets" class="num float-right">0</span></p>
                 <p>Abgeschlossene Forschungen: <span id="stat-research-completed" class="num float-right">0</span></p>
             </div>
             <div id="prestige-tab" class="tab-content space-y-4 text-center prestige-tab-content"> <h3 class="text-xl font-semibold mb-3 text-indigo-300">Prestige ✨</h3>
                 <p class="text-gray-300 mb-2">Setze deinen Fortschritt zurück, um Mondkristalle ✨ zu erhalten.</p>
                 <p class="text-gray-300 mb-2">Jeder Kristall erhöht deine gesamte Mondstaub-Produktion dauerhaft um <span class="num">1</span>%.</p>
                 <p class="text-sm text-gray-400 mt-4">Fortschritt zum nächsten Prestige:</p>
                 <div class="progress-bar-container"><div id="prestige-progress-bar" class="progress-bar progress-bar-prestige"><span id="prestige-progress-percent">0%</span></div></div>
                 <p class="mb-4">Aktuelle Mondkristalle: <span id="prestige-current-crystals" class="num text-xl text-cyan-400">0</span></p>
                 <p class="mb-4">Kristalle bei nächstem Prestige: <span id="prestige-next-crystals" class="num text-xl text-cyan-400">0</span></p>
                 <button id="prestige-button" class="w-full bg-gradient-to-br from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg"> Prestige auslösen (Benötigt: <span id="prestige-requirement" class="num">1M</span> 🌙)</button>
                 <p id="prestige-warning" class="text-xs text-red-400 mt-2 hidden">Nicht genügend Staub 🌙 oder keine neuen Kristalle ✨ verfügbar.</p>
             </div>
             <div id="leaderboard-tab" class="tab-content space-y-4 text-center leaderboard-tab-content"> <h3 class="text-xl font-semibold mb-3 text-indigo-300">Rangliste (Beispiel)</h3>
                 <p class="text-sm text-gray-400 mb-4">Dies ist eine Beispiel-Rangliste.</p>
                 <ol class="list-decimal list-inside text-left space-y-1 text-gray-300">
                       <li>Cmdr. Alex - 1.23P Kristalle ✨</li> <li>Captain Eva - 987T Kristalle ✨</li> <li>Pilot Max - 543T Kristalle ✨</li> <li>Navigator Sam - 210T Kristalle ✨</li> <li>Ensign Riley - 88.8T Kristalle ✨</li> <li>...</li> <li>Du - <span id="leaderboard-player-rank" class="num">???</span> Kristalle ✨</li>
                 </ol>
             </div>
             <div id="settings-tab" class="tab-content space-y-3 settings-tab-content">
                 <h3 class="text-xl font-semibold mb-3 text-indigo-300 text-center">Einstellungen ⚙️</h3>
                 <p class="text-sm text-gray-400 mb-4">Spielstand verwalten.</p>
                 <button id="manual-save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Spiel speichern</button>
                 <button id="manual-load-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2">Spiel laden (Seite neu laden)</button>
                 <p class="text-xs text-gray-500 mt-4">Das Spiel speichert automatisch alle 15 Sekunden.</p>
                 </div>
        </div>

        <footer class="game-footer">
             <button id="admin-menu-button-footer" title="Admin Menü öffnen" class="text-xs text-gray-500 hover:text-indigo-400 p-1 rounded transition mb-2">
                 Admin
             </button>
             <button id="changelog-button-footer" title="Changelog anzeigen" class="text-xs text-gray-500 hover:text-indigo-400 p-1 rounded transition mb-2 mt-2">
                 Changelog
             </button>
             <br> <a href="https://astronerd.flarum.cloud/" target="_blank" rel="noopener noreferrer">
                 Powerd by WuM @ AstroNerds
             </a>
        </footer>
    </div> <div id="admin-password-modal-overlay" class="modal-overlay">
        <div class="modal-content space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-indigo-400">Admin Login</h2>
                <button id="close-password-modal" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <p class="text-sm text-gray-400">Bitte Admin-Passwort eingeben:</p>
            <input type="password" id="admin-password-input" placeholder="Passwort">
            <p id="password-error-message" class="text-xs text-red-400 hidden">Falsches Passwort.</p>
            <button id="submit-password-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Einloggen</button>
        </div>
    </div>

    <div id="admin-controls-modal-overlay" class="modal-overlay">
        <div class="modal-content space-y-4">
             <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-indigo-400">Admin Steuerung</h2>
                <button id="close-admin-controls-modal" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <p class="text-sm text-gray-400">Admin-Funktionen:</p>
            <button id="admin-add-dust" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">1M Staub 🌙 hinzufügen</button>
            <button id="admin-add-energy" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">1M Energie ⚡ hinzufügen</button>
            <button id="admin-add-metal" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded">1M Metall 🔩 hinzufügen</button>
            <button id="admin-add-crystals" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">100 Kristalle ✨ hinzufügen</button>
             <button id="reset-button" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded mt-4">Spielstand komplett ZURÜCKSETZEN</button>
        </div>
    </div>

    <div id="changelog-modal-overlay" class="modal-overlay">
        <div id="changelog-modal-content" class="modal-content space-y-4 text-left">
            <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold text-indigo-400">Changelog</h2>
                 <button id="close-changelog-modal" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="changelog mt-0 pt-0 border-none">
                 <ul>
                     <li>**v8.9c:** Einstellungen-Tab hinzugefügt (man. Speichern/Laden), Kosten (Silo, Mining) weiter gesenkt, Partikel bei Klick.</li>
                     <li>**v8.9b+:** KOSTEN ANGEPASST (geringere Multiplikatoren für leichtere Progression).</li>
                     <li>**v8.9b:** UX: Kapazitätswarnung (Farbe), Speicher-Toast, Tooltips, Hervorhebung kaufbarer Items.</li>
                     <li>**v8.9:** Lagersilos hinzugefügt (erhöht 🌙 & 🔩 Kapazität). Header zeigt nun Max. Kapazität.</li>
                     <li>**v8.8:** Zahlenformatierung (K, M, B...) implementiert.</li>
                     <li>**v8.7:** Energiespeicher hinzugefügt.</li>
                     <li>**v8.6:** Ressourcen-Fortschrittsbalken im Header.</li>
                     <li>**v8.5:** Layout-Anpassungen (Admin im Footer, Notifikations-Button).</li>
                     <li>**v8.4:** Raumschiffswerft & Schiffsforschung hinzugefügt.</li>
                     <li>**v8.3:** Ressourcen im Header platziert.</li>
                     <li>**v8.2:** Burger-Menü & Toast-Benachrichtigungen.</li>
                     <li>**v8.1:** Header-Navigation.</li>
                     <li>**v8.0:** Bevölkerung, Forschung (Basis), Handel (Basis), Koloniebonus.</li>
                     <li>**v7.x:** Design-Modernisierung, Animationen, Fehlerbehebungen.</li>
                    <li>... (ältere Versionen)</li>
                 </ul>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script>
         // --- Constants ---
         const PRESTIGE_CRYSTAL_EFFECT = 0.01;
         const PRESTIGE_REQUIREMENT_SCALE = 10;
         const SAVE_KEY = 'idleMoonsGameState_v8.9c_costs_particles'; // Key angepasst für neue Version
         const TICK_RATE_MS = 100;
         const THREAT_CHECK_INTERVAL_MS = 10000;
         const THREAT_BASE_CHANCE = 0.1;
         const THREAT_BASE_HEALTH = 100;
         const THREAT_HEALTH_SCALE = 1.5;
         const THREAT_COST_BASE = 50;
         const THREAT_COST_SCALE = 1.2;
         const THREAT_PENALTY_MULTIPLIER = 0.5;
         const SHIELD_COST_REDUCTION_PER_LEVEL = 0.02;
         const TURRET_DAMAGE_PER_LEVEL = 0.5;
         const ADMIN_PASSWORD = "IdleMoons-v1";
         const COLONY_PRODUCTION_BONUS = 0.01;
         const HOUSING_CAPACITY_PER_LEVEL = 10;
         const BASE_ENERGY_CAPACITY = 1000;
         const ENERGY_STORAGE_CAPACITY_PER_LEVEL = 500;
         const BASE_DUST_CAPACITY = 1000;
         const BASE_METAL_CAPACITY = 500;
         const SILO_DUST_CAPACITY_PER_LEVEL = 1000;
         const SILO_METAL_CAPACITY_PER_LEVEL = 500;
         const CAPACITY_WARNING_THRESHOLD = 0.9; // 90%

         // Planet, Research, Ship Definitions (wie zuvor)
         const PLANETS = { moon: { name: "Mond", icon: "🌙", buildableSlots: 10, graphicClass: "moon" }, mars: { name: "Mars", icon: "🪐", cost: 5e6, description: "Der rote Nachbar.", colonized: false, buildableSlots: 15, graphicClass: "mars" }, venus: { name: "Venus", icon: "🪐", cost: 1e8, description: "Heiß und unwirtlich.", colonized: false, buildableSlots: 8, graphicClass: "venus" }, jupiter: { name: "Jupiter", icon: "🪐", cost: 5e9, description: "Gasriese.", colonized: false, buildableSlots: 25, graphicClass: "jupiter" }, };
         const RESEARCH = { collectorEfficiency: { id: 'collectorEfficiency', name: 'Verbesserte Sammler', description: 'Erhöht Basisproduktion um +10%.', cost: { resources: 10000 }, bonusKey: 'collectorEfficiencyBonus', bonusValue: 1.1, statusElementId: 'research-collector-status', buttonElementId: 'research-collector-button', costElementId: 'research-collector-cost', }, energyEfficiency: { id: 'energyEfficiency', name: 'Energieeffizienz', description: 'Reduziert Energiekosten um 5%.', cost: { energy: 5000 }, bonusKey: 'defenseEnergyCostMultiplier', bonusValue: 0.95, statusElementId: 'research-energy-status', buttonElementId: 'research-energy-button', costElementId: 'research-energy-cost', }, cargoTech: { id: 'cargoTech', name: 'Frachtraumtechnologie', description: 'Schaltet Transporter frei.', cost: { resources: 25000, metal: 1000 }, unlocks: 'shipyard-transport', statusElementId: 'research-cargo-status', buttonElementId: 'research-cargo-button', costElementId: 'research-cargo-cost', costElementIdMetal: 'research-cargo-cost-metal', }, propulsionTech: { id: 'propulsionTech', name: 'Antriebssysteme', description: 'Schaltet Jäger frei.', cost: { resources: 50000, energy: 2000 }, unlocks: 'shipyard-fighter', statusElementId: 'research-propulsion-status', buttonElementId: 'research-propulsion-button', costElementId: 'research-propulsion-cost', costElementIdEnergy: 'research-propulsion-cost-energy', }, colonizationTech: { id: 'colonizationTech', name: 'Kolonisationstechnologie', description: 'Schaltet Kolonieschiffe frei.', cost: { resources: 100000, metal: 5000 }, unlocks: 'shipyard-colony', statusElementId: 'research-colonization-status', buttonElementId: 'research-colonization-button', costElementId: 'research-colonization-cost', costElementIdMetal: 'research-colonization-cost-metal', }, };
         const SHIPS = { transport: { id: 'transport', name: 'Transporter', icon: '🚚', cost: { metal: 1000 }, buildButtonId: 'build-transport', countElementId: 'ship-count-transport', costElementId: 'build-cost-transport', requiresResearch: 'cargoTech' }, fighter: { id: 'fighter', name: 'Jäger', icon: '🚀', cost: { metal: 500, energy: 1000 }, buildButtonId: 'build-fighter', countElementId: 'ship-count-fighter', costElementId: 'build-cost-fighter', costElementIdEnergy: 'build-cost-fighter-energy', requiresResearch: 'propulsionTech' }, colony: { id: 'colony', name: 'Kolonieschiff', icon: '🛰️', cost: { metal: 10000, energy: 5000 }, buildButtonId: 'build-colony', countElementId: 'ship-count-colony', costElementId: 'build-cost-colony', costElementIdEnergy: 'build-cost-colony-energy', requiresResearch: 'colonizationTech' } };
         // --- Game State ---
         let gameState = getDefaultGameState();
         let activeTab = 'overview';

         // --- DOM Elements --- (komplette Liste, inkl. neuer Settings-Buttons)
         const resourceCountElement = document.getElementById('resource-count'); const resourceRateElement = document.getElementById('resource-rate')?.querySelector('span'); const resourceCapacityElement = document.getElementById('resource-capacity'); const energyCountElement = document.getElementById('energy-count'); const energyRateElement = document.getElementById('energy-rate')?.querySelector('span'); const energyCapacityElement = document.getElementById('energy-capacity'); const metalCountElement = document.getElementById('metal-count'); const metalRateElement = document.getElementById('metal-rate')?.querySelector('span'); const metalCapacityElement = document.getElementById('metal-capacity'); const populationCountElement = document.getElementById('population-count'); const populationRateElement = document.getElementById('population-rate')?.querySelector('span'); const populationCapacityElement = document.getElementById('population-capacity'); const manualCollectButton = document.getElementById('manual-collect-button'); const manualCollectAmountElement = document.getElementById('manual-collect-amount'); const prestigeBonusDisplay = document.getElementById('prestige-bonus-display'); const prestigeBonusPercent = document.getElementById('prestige-bonus-percent'); const colonyBonusDisplay = document.getElementById('colony-bonus-display'); const colonyBonusPercent = document.getElementById('colony-bonus-percent'); const prestigeButton = document.getElementById('prestige-button'); const prestigeCurrentCrystals = document.getElementById('prestige-current-crystals'); const prestigeNextCrystals = document.getElementById('prestige-next-crystals'); const prestigeRequirementElement = document.getElementById('prestige-requirement'); const prestigeWarning = document.getElementById('prestige-warning'); const prestigeProgressBarElement = document.getElementById('prestige-progress-bar'); const prestigeProgressPercentElement = document.getElementById('prestige-progress-percent'); const resetButton = document.getElementById('reset-button'); const burgerButton = document.getElementById('burger-button'); const burgerMenuOverlay = document.getElementById('burger-menu-overlay'); const burgerMenu = document.getElementById('burger-menu'); const menuItems = burgerMenu?.querySelectorAll('.menu-item'); const tabContents = document.querySelectorAll('.tab-content'); const tabContentContainer = document.getElementById('tab-content-container'); const planetListContainer = document.getElementById('planet-list'); const leaderboardPlayerRank = document.getElementById('leaderboard-player-rank'); const statTotalResources = document.getElementById('stat-total-resources'); const statTotalEnergy = document.getElementById('stat-total-energy'); const statTotalMetal = document.getElementById('stat-total-metal'); const statPopulation = document.getElementById('stat-population'); const statShipTransport = document.getElementById('stat-ship-transport'); const statShipFighter = document.getElementById('stat-ship-fighter'); const statShipColony = document.getElementById('stat-ship-colony'); const statTotalClicks = document.getElementById('stat-total-clicks'); const statThreatsDefeated = document.getElementById('stat-threats-defeated'); const statPlayTime = document.getElementById('stat-play-time'); const statMoonCrystals = document.getElementById('stat-moon-crystals'); const statColonizedPlanets = document.getElementById('stat-colonized-planets'); const statResearchCompleted = document.getElementById('stat-research-completed'); const adminMenuButtonFooter = document.getElementById('admin-menu-button-footer'); const adminPasswordModalOverlay = document.getElementById('admin-password-modal-overlay'); const adminPasswordInput = document.getElementById('admin-password-input'); const submitPasswordButton = document.getElementById('submit-password-button'); const closePasswordModalButton = document.getElementById('close-password-modal'); const passwordErrorMessage = document.getElementById('password-error-message'); const adminControlsModalOverlay = document.getElementById('admin-controls-modal-overlay'); const closeAdminControlsModalButton = document.getElementById('close-admin-controls-modal'); const adminAddDustButton = document.getElementById('admin-add-dust'); const adminAddEnergyButton = document.getElementById('admin-add-energy'); const adminAddMetalButton = document.getElementById('admin-add-metal'); const adminAddCrystalsButton = document.getElementById('admin-add-crystals'); const tradeDustForEnergyButton = document.getElementById('trade-dust-for-energy'); const tradeEnergyForMetalButton = document.getElementById('trade-energy-for-metal'); const toastContainer = document.getElementById('toast-container'); const notificationButton = document.getElementById('notification-button'); const currentLocationNameElement = document.getElementById('current-location-name'); const locationGraphicElement = document.getElementById('location-graphic'); const overviewFieldsCurrentElement = document.getElementById('overview-fields-current'); const overviewFieldsMaxElement = document.getElementById('overview-fields-max'); const overviewFieldsBarElement = document.getElementById('overview-fields-bar'); const overviewPopulationCurrentElement = document.getElementById('overview-population-current'); const overviewPopulationMaxElement = document.getElementById('overview-population-max'); const overviewPopulationBarElement = document.getElementById('overview-population-bar'); const resourceBarDust = document.getElementById('resource-bar-dust'); const resourceBarEnergy = document.getElementById('resource-bar-energy'); const resourceBarMetal = document.getElementById('resource-bar-metal'); const resourceBarPopulation = document.getElementById('resource-bar-population'); const changelogButtonFooter = document.getElementById('changelog-button-footer'); const changelogModalOverlay = document.getElementById('changelog-modal-overlay'); const closeChangelogModalButton = document.getElementById('close-changelog-modal');
         const manualSaveButton = document.getElementById('manual-save-button'); // NEU
         const manualLoadButton = document.getElementById('manual-load-button'); // NEU
         const headerDustElement = document.getElementById('header-dust'); const headerEnergyElement = document.getElementById('header-energy'); const headerMetalElement = document.getElementById('header-metal'); const headerPopulationElement = document.getElementById('header-population');

         // Upgrade Elements Map
         const upgradeElements = { collector: { button: document.getElementById('upgrade-collector'), level: document.getElementById('collector-level'), increase: document.getElementById('collector-increase') }, rover: { button: document.getElementById('upgrade-rover'), level: document.getElementById('rover-level'), increase: document.getElementById('rover-increase') }, efficiency: { button: document.getElementById('upgrade-efficiency'), level: document.getElementById('efficiency-level') }, clickPower: { button: document.getElementById('upgrade-click-power'), level: document.getElementById('click-power-level'), increase: document.getElementById('click-power-increase') }, clickMultiplier: { button: document.getElementById('upgrade-click-multiplier'), level: document.getElementById('click-multiplier-level'), value: document.getElementById('click-multiplier-value') }, generator: { button: document.getElementById('upgrade-generator'), level: document.getElementById('generator-level'), increase: document.getElementById('generator-increase') }, storage: { button: document.getElementById('upgrade-storage'), level: document.getElementById('storage-level'), increase: document.getElementById('storage-increase') }, mining: { button: document.getElementById('upgrade-mining'), level: document.getElementById('mining-level'), increase: document.getElementById('mining-increase') }, housing: { button: document.getElementById('upgrade-housing'), level: document.getElementById('housing-level'), increase: document.getElementById('housing-increase') }, shield: { button: document.getElementById('upgrade-shield'), level: document.getElementById('shield-level'), effect: document.getElementById('shield-effect') }, turret: { button: document.getElementById('upgrade-turret'), level: document.getElementById('turret-level'), damage: document.getElementById('turret-damage') }, silo: { button: document.getElementById('upgrade-silo'), level: document.getElementById('silo-level'), dustIncrease: document.getElementById('silo-dust-increase'), metalIncrease: document.getElementById('silo-metal-increase'), costDust: document.getElementById('silo-cost-dust'), costMetal: document.getElementById('silo-cost-metal') }, };

         // --- Utility Functions ---
         function formatIdleNumber(numberInput, decimals = 2) { const number = Number(numberInput); if (numberInput === null || numberInput === undefined || isNaN(number)) { return '0'; } if (number === 0) { return '0'; } const isNegative = number < 0; const absNumber = Math.abs(number); if (absNumber < 1000) { const fixedDecimals = (absNumber % 1 === 0) ? 0 : decimals; return (isNegative ? '-' : '') + absNumber.toFixed(fixedDecimals); } const SI_SUFFIXES = ['', 'K', 'M', 'B', 'T', 'P', 'E', 'Z', 'Y']; const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'; const tier = Math.floor(Math.log10(absNumber) / 3); let suffix = ''; if (tier < SI_SUFFIXES.length) { suffix = SI_SUFFIXES[tier]; } else { const suffixTier = tier - SI_SUFFIXES.length; const firstLetterIndex = Math.floor(suffixTier / ALPHABET.length); const secondLetterIndex = suffixTier % ALPHABET.length; if (firstLetterIndex >= ALPHABET.length) { return (isNegative ? '-' : '') + absNumber.toExponential(decimals); } suffix = ALPHABET[firstLetterIndex] + ALPHABET[secondLetterIndex]; } const scale = Math.pow(1000, tier); const scaledNumber = absNumber / scale; const formattedScaledNumber = scaledNumber.toFixed(decimals); return (isNegative ? '-' : '') + formattedScaledNumber + suffix; }
         function formatTime(seconds) { seconds = Number(seconds); if (seconds == null || isNaN(seconds) || seconds < 0) return '0s'; const s = Math.floor(seconds % 60); const m = Math.floor((seconds / 60) % 60); const h = Math.floor((seconds / (60 * 60)) % 24); const d = Math.floor(seconds / (60 * 60 * 24)); let str = ""; if (d > 0) str += `${d}d `; if (h > 0) str += `${h}h `; if (m > 0) str += `${m}m `; str += `${s}s`; return str.trim() || "0s"; }
         function triggerAnimation(element, animationClass) { if (element) { element.classList.remove(animationClass); void element.offsetWidth; element.classList.add(animationClass); element.addEventListener('animationend', () => { element.classList.remove(animationClass); }, { once: true }); } }
         function triggerResourceUpdateAnimation(element) { if (element) { element.classList.add('updated'); setTimeout(() => { element.classList.remove('updated'); }, 200); } }
         function showToast(message, type = 'info', duration = 5000) { if (!toastContainer) return; const toast = document.createElement('div'); toast.className = `toast toast-${type}`; const messageSpan = document.createElement('span'); messageSpan.innerHTML = message; const closeButton = document.createElement('button'); closeButton.innerHTML = '&times;'; closeButton.className = 'toast-close-button'; closeButton.onclick = () => removeToast(toast); toast.appendChild(messageSpan); toast.appendChild(closeButton); toastContainer.appendChild(toast); const timeoutId = setTimeout(() => removeToast(toast), duration); toast.dataset.timeoutId = timeoutId; }
         function removeToast(toastElement) { if (!toastElement || !toastElement.parentNode) return; clearTimeout(toastElement.dataset.timeoutId); toastElement.classList.add('exiting'); toastElement.addEventListener('animationend', () => { if (toastElement.parentNode === toastContainer) { toastContainer.removeChild(toastElement); } }, { once: true }); }
         // --- Game Logic ---
         function getStateNum(key, defaultValue = 0) { return Number(gameState[key]) || defaultValue; }
         function calculateCost(baseCostKey, multiplierKey, level) { const base = gameState[baseCostKey] !== undefined ? getStateNum(baseCostKey) : 10; const mult = gameState[multiplierKey] !== undefined ? getStateNum(multiplierKey, 1.1) : 1.1; return Math.floor(base * Math.pow(mult, level || 0)); }
         function calculateMultiResourceCost(baseCosts, multipliers, level) { const costs = {}; for (const resource in baseCosts) { const base = baseCosts[resource] || 0; const mult = multipliers[resource] || 1.1; costs[resource] = Math.floor(base * Math.pow(mult, level || 0)); } return costs; }
         function getPrestigeBonus() { return 1 + (getStateNum('moonCrystals') * PRESTIGE_CRYSTAL_EFFECT); }
         function getColonyBonus() { const count = countColonizedPlanets(); return 1 + (count * COLONY_PRODUCTION_BONUS); }
         function calculateResourceRate() { let baseCollectorRate = getStateNum('collectorLevel') * getStateNum('collectorBaseIncrease', 1); let baseRoverRate = getStateNum('roverLevel') * getStateNum('roverBaseIncrease', 10); if (gameState.research?.collectorEfficiency) { baseCollectorRate *= RESEARCH.collectorEfficiency.bonusValue; baseRoverRate *= RESEARCH.collectorEfficiency.bonusValue; } const baseRate = baseCollectorRate + baseRoverRate; const efficiencyMultiplier = Math.pow(2, getStateNum('efficiencyLevel')); const prestigeMultiplier = getPrestigeBonus(); const colonyMultiplier = getColonyBonus(); let finalRate = baseRate * efficiencyMultiplier * prestigeMultiplier * colonyMultiplier; if (gameState.activeThreat) { finalRate *= THREAT_PENALTY_MULTIPLIER; } return finalRate; }
         function calculateEnergyRate() { return getStateNum('generatorLevel') * getStateNum('generatorBaseIncrease', 1); }
         function calculateMetalRate() { return getStateNum('miningLevel') * getStateNum('miningBaseIncrease', 1); }
         function calculatePopulationRate() { const pop = getStateNum('population'), cap = calculatePopulationCapacity(); if (pop >= cap) return 0; return getStateNum('housingLevel') * getStateNum('housingBaseIncrease', 0.1); }
         function calculateResourceCapacity() { return BASE_DUST_CAPACITY + (getStateNum('siloLevel') * SILO_DUST_CAPACITY_PER_LEVEL); }
         function calculateMetalCapacity() { return BASE_METAL_CAPACITY + (getStateNum('siloLevel') * SILO_METAL_CAPACITY_PER_LEVEL); }
         function calculateEnergyCapacity() { return BASE_ENERGY_CAPACITY + (getStateNum('storageLevel') * ENERGY_STORAGE_CAPACITY_PER_LEVEL); }
         function calculatePopulationCapacity() { return 10 + (getStateNum('housingLevel') * HOUSING_CAPACITY_PER_LEVEL); }
         function calculateManualCollectAmount() { const base = 1 + (getStateNum('clickPowerLevel') * getStateNum('clickPowerBaseIncrease', 1)); const mult = Math.pow(1.5, getStateNum('clickMultiplierLevel')); return Math.floor(base * mult); }
         function getPrestigeRequirement() { return Math.floor(getStateNum('prestigeRequirementBase', 1e6) * Math.pow(PRESTIGE_REQUIREMENT_SCALE, getStateNum('moonCrystals'))); }
         function calculatePotentialNewCrystals() { const potential = Math.floor(Math.sqrt((getStateNum('totalResourcesCollected') + getStateNum('resources')) / 1e7)); return Math.max(0, potential - getStateNum('moonCrystals')); }
         function countColonizedPlanets() { return gameState.colonizedPlanets ? Object.values(gameState.colonizedPlanets).filter(c => c).length : 0; }
         function countCompletedResearch() { return gameState.research ? Object.values(gameState.research).filter(r => r).length : 0; }
         function calculateThreatCost() { if (!gameState.activeThreat) return 0; const threatMaxHealth = gameState.activeThreat.maxHealth || THREAT_BASE_HEALTH; const healthFactor = Math.log10(Math.max(1, threatMaxHealth)); const baseCost = THREAT_COST_BASE * Math.pow(THREAT_COST_SCALE, healthFactor); const researchMultiplier = gameState.research?.energyEfficiency ? RESEARCH.energyEfficiency.bonusValue : 1; const shieldReduction = 1.0 - Math.min(0.9, getStateNum('shieldLevel') * SHIELD_COST_REDUCTION_PER_LEVEL); return Math.max(1, Math.floor(baseCost * shieldReduction * researchMultiplier)); }
         function calculateDefenseUpgradeCost(baseCostKey, multiplierKey, level) { let cost = calculateCost(baseCostKey, multiplierKey, level); if (gameState.research?.energyEfficiency) { cost *= RESEARCH.energyEfficiency.bonusValue; } return Math.max(1, Math.floor(cost)); }
         function calculateTurretDPS() { return getStateNum('turretLevel') * TURRET_DAMAGE_PER_LEVEL; }

         // --- UI Update ---
         function updateText(element, value) { if (element && element.textContent !== value) { element.textContent = value; if (element.classList.contains('resource-value')) { triggerResourceUpdateAnimation(element); } } }
         function updateButtonState(button, canAfford) { if (button) { button.disabled = !canAfford; button.classList.toggle('affordable-highlight', canAfford); } }
         function setTooltip(element, text) { if (element && element.title !== text) { element.title = text; } }

         function updateUI() {
             const currentResources = getStateNum('resources'); const resourceCapacity = calculateResourceCapacity(); const currentResourceRate = calculateResourceRate();
             const currentEnergy = getStateNum('energy'); const energyCapacity = calculateEnergyCapacity(); const currentEnergyRate = calculateEnergyRate();
             const currentMetal = getStateNum('metal'); const metalCapacity = calculateMetalCapacity(); const currentMetalRate = calculateMetalRate();
             const currentPopulation = getStateNum('population'); const populationCapacity = calculatePopulationCapacity(); const currentPopulationRate = calculatePopulationRate();
             const currentManualCollectAmount = calculateManualCollectAmount(); const prestigeBonus = getPrestigeBonus(); const colonyBonus = getColonyBonus();

             // Header Resources
             updateText(resourceCountElement, formatIdleNumber(currentResources)); updateText(resourceRateElement, formatIdleNumber(currentResourceRate, 1)); updateText(resourceCapacityElement, `Max: ${formatIdleNumber(resourceCapacity)}`); setTooltip(headerDustElement, `Mondstaub: ${currentResources.toLocaleString('de-DE')}`); const dustPercent = resourceCapacity > 0 ? (currentResources / resourceCapacity) * 100 : 0; if (resourceBarDust) { resourceBarDust.style.width = `${Math.min(100, dustPercent)}%`; resourceBarDust.classList.toggle('warning', dustPercent >= CAPACITY_WARNING_THRESHOLD * 100); }
             updateText(energyCountElement, formatIdleNumber(currentEnergy)); updateText(energyRateElement, formatIdleNumber(currentEnergyRate, 1)); updateText(energyCapacityElement, `Max: ${formatIdleNumber(energyCapacity)}`); setTooltip(headerEnergyElement, `Energie: ${currentEnergy.toLocaleString('de-DE')}`); const energyPercent = energyCapacity > 0 ? (currentEnergy / energyCapacity) * 100 : 0; if (resourceBarEnergy) { resourceBarEnergy.style.width = `${Math.min(100, energyPercent)}%`; const isNearCapacity = energyPercent >= CAPACITY_WARNING_THRESHOLD * 100; const isLow = energyPercent < 20 && !isNearCapacity; resourceBarEnergy.classList.toggle('warning', isNearCapacity); resourceBarEnergy.classList.toggle('low', isLow); if (isNearCapacity && isLow) resourceBarEnergy.classList.remove('low'); else if (!isNearCapacity && !isLow) { resourceBarEnergy.classList.remove('warning'); resourceBarEnergy.classList.remove('low'); } }
             updateText(metalCountElement, formatIdleNumber(currentMetal)); updateText(metalRateElement, formatIdleNumber(currentMetalRate, 1)); updateText(metalCapacityElement, `Max: ${formatIdleNumber(metalCapacity)}`); setTooltip(headerMetalElement, `Metall: ${currentMetal.toLocaleString('de-DE')}`); const metalPercent = metalCapacity > 0 ? (currentMetal / metalCapacity) * 100 : 0; if (resourceBarMetal) { resourceBarMetal.style.width = `${Math.min(100, metalPercent)}%`; resourceBarMetal.classList.toggle('warning', metalPercent >= CAPACITY_WARNING_THRESHOLD * 100); }
             updateText(populationCountElement, formatIdleNumber(currentPopulation, 0)); updateText(populationRateElement, formatIdleNumber(currentPopulationRate, 1)); updateText(populationCapacityElement, `Max: ${formatIdleNumber(populationCapacity, 0)}`); setTooltip(headerPopulationElement, `Bevölkerung: ${currentPopulation.toLocaleString('de-DE')}`); const populationPercent = populationCapacity > 0 ? (currentPopulation / populationCapacity) * 100 : 0; if (resourceBarPopulation) { resourceBarPopulation.style.width = `${Math.min(100, populationPercent)}%`; resourceBarPopulation.classList.toggle('warning', populationPercent >= CAPACITY_WARNING_THRESHOLD * 100); }

             // Manual Collect Button
             updateText(manualCollectAmountElement, formatIdleNumber(currentManualCollectAmount, 0)); setTooltip(manualCollectButton, `Sammelt ${formatIdleNumber(currentManualCollectAmount, 0)} Mondstaub`);

             // Bonus Displays
             const crystals = getStateNum('moonCrystals'); if (prestigeBonusDisplay) { prestigeBonusDisplay.classList.toggle('hidden', crystals <= 0); if (crystals > 0) { updateText(prestigeBonusPercent, ((prestigeBonus - 1) * 100).toFixed(0)); } }
             const colonizedCount = countColonizedPlanets(); if (colonyBonusDisplay) { colonyBonusDisplay.classList.toggle('hidden', colonizedCount <= 0); if (colonizedCount > 0) { updateText(colonyBonusPercent, ((colonyBonus - 1) * 100).toFixed(0)); } }

             // Update Active Tab
             try { switch(activeTab) { case 'overview': updateOverviewTab(currentResources, currentEnergy, currentMetal, currentPopulation); break; case 'build-menu': updateBuildMenuTab(currentResources, currentEnergy, currentMetal); break; case 'defense': updateDefenseTab(currentResources, currentEnergy, currentMetal); break; case 'shipyard': updateShipyardTab(currentResources, currentEnergy, currentMetal); break; case 'research': updateResearchTab(currentResources, currentEnergy, currentMetal); break; case 'planets': updatePlanetsTab(currentResources, currentEnergy, currentMetal); break; case 'trade': updateTradeTab(currentResources, currentEnergy, currentMetal); break; case 'stats': updateStatsTab(); break; case 'prestige': updatePrestigeTab(currentResources); break; case 'leaderboard': updateLeaderboardTab(); break; case 'settings': updateSettingsTab(); break; /* NEU */ } } catch (error) { console.error(`Error updating tab ${activeTab}:`, error); }

             // Update Notification Button State
             if (notificationButton) { notificationButton.classList.toggle('active', !!gameState.activeThreat); }
         }
         // --- Tab Specific Update Functions ---
         function updateOverviewTab(currentResources, currentEnergy, currentMetal, currentPopulation) { const currentLocationId = 'moon'; const locationData = PLANETS[currentLocationId]; updateText(currentLocationNameElement, locationData.name); if (locationGraphicElement) { locationGraphicElement.className = `planet-graphic ${locationData.graphicClass || 'moon'}`; locationGraphicElement.innerHTML = `<span>${locationData.icon || '📍'}</span>`; } const maxFields = locationData.buildableSlots || 10; const currentFields = 0; updateText(overviewFieldsCurrentElement, currentFields); updateText(overviewFieldsMaxElement, maxFields); const fieldsPercent = maxFields > 0 ? Math.min(100, (currentFields / maxFields) * 100) : 0; if(overviewFieldsBarElement) overviewFieldsBarElement.style.width = `${fieldsPercent}%`; const capacity = calculatePopulationCapacity(); updateText(overviewPopulationCurrentElement, formatIdleNumber(currentPopulation, 0)); updateText(overviewPopulationMaxElement, formatIdleNumber(capacity, 0)); const populationPercent = capacity > 0 ? Math.min(100, (currentPopulation / capacity) * 100) : 0; if(overviewPopulationBarElement) overviewPopulationBarElement.style.width = `${populationPercent}%`; }
         function updateBuildMenuTab(currentResources, currentEnergy, currentMetal) { const updateSingleResourceCard = (key, costResKey, costIcon, effectDescFunc) => { const els = upgradeElements[key]; if (!els || !els.button) return; const levelProp = `${key}Level`, baseCostProp = `${key}BaseCost`, multiplierProp = `${key}CostMultiplier`; const level = getStateNum(levelProp); let cost; if (key === 'shield' || key === 'turret') { cost = calculateDefenseUpgradeCost(baseCostProp, multiplierProp, level); } else { cost = calculateCost(baseCostProp, multiplierProp, level); } const canAfford = getStateNum(costResKey) >= cost; updateButtonState(els.button, canAfford); updateText(els.level, level); if (els.increase) updateText(els.increase, formatIdleNumber(getStateNum(`${key}BaseIncrease`, 1), (key.includes('storage') || key.includes('silo')) ? 1:0)); if (els.value) updateText(els.value, Math.pow(1.5, level).toFixed(1)); let tooltipText = effectDescFunc ? effectDescFunc(level + 1) : `Level ${level + 1}`; tooltipText += ` Kosten: ${formatIdleNumber(cost)} ${costIcon}`; setTooltip(els.button, tooltipText); const costSpan = els.button.querySelector('.num'); if (costSpan) { updateText(costSpan, formatIdleNumber(cost)); } else { els.button.innerHTML = `Kosten: <span class="num">${formatIdleNumber(cost)}</span> ${costIcon}`; } }; const collectorDesc = (lvl) => `Level ${lvl}: +${formatIdleNumber(getStateNum('collectorBaseIncrease'))}/s.`; const roverDesc = (lvl) => `Level ${lvl}: +${formatIdleNumber(getStateNum('roverBaseIncrease'))}/s.`; const efficiencyDesc = (lvl) => `Level ${lvl}: Verdoppelt Produktion (x${Math.pow(2,lvl)}).`; const clickPowerDesc = (lvl) => `Level ${lvl}: +${formatIdleNumber(getStateNum('clickPowerBaseIncrease'))}/Klick.`; const clickMultDesc = (lvl) => `Level ${lvl}: Multipliziert Klick (x${Math.pow(1.5, lvl).toFixed(1)})`; const generatorDesc = (lvl) => `Level ${lvl}: +${formatIdleNumber(getStateNum('generatorBaseIncrease'))}/s.`; const storageDesc = (lvl) => `Level ${lvl}: Max. Energie +${formatIdleNumber(ENERGY_STORAGE_CAPACITY_PER_LEVEL)}.`; const miningDesc = (lvl) => `Level ${lvl}: +${formatIdleNumber(getStateNum('miningBaseIncrease'))}/s.`; const housingDesc = (lvl) => `Level ${lvl}: +${getStateNum('housingBaseIncrease', 0.1).toFixed(1)} Bev./s, +${HOUSING_CAPACITY_PER_LEVEL} Kapazität.`; updateSingleResourceCard('collector', 'resources', '🌙', collectorDesc); updateSingleResourceCard('rover', 'resources', '🌙', roverDesc); updateSingleResourceCard('efficiency', 'resources', '🌙', efficiencyDesc); updateSingleResourceCard('clickPower', 'resources', '🌙', clickPowerDesc); updateSingleResourceCard('clickMultiplier', 'resources', '🌙', clickMultDesc); updateSingleResourceCard('generator', 'resources', '🌙', generatorDesc); updateSingleResourceCard('storage', 'metal', '🔩', storageDesc); updateSingleResourceCard('mining', 'resources', '🌙', miningDesc); updateSingleResourceCard('housing', 'metal', '🔩', housingDesc); const siloEls = upgradeElements.silo; if (siloEls && siloEls.button) { const siloLevel = getStateNum('siloLevel'); const siloCosts = calculateMultiResourceCost({ resources: gameState.siloBaseCostDust, metal: gameState.siloBaseCostMetal }, { resources: gameState.siloCostMultiplier, metal: gameState.siloCostMultiplier }, siloLevel); const canAffordSilo = currentResources >= siloCosts.resources && currentMetal >= siloCosts.metal; updateButtonState(siloEls.button, canAffordSilo); updateText(siloEls.level, siloLevel); updateText(siloEls.dustIncrease, formatIdleNumber(SILO_DUST_CAPACITY_PER_LEVEL)); updateText(siloEls.metalIncrease, formatIdleNumber(SILO_METAL_CAPACITY_PER_LEVEL)); updateText(siloEls.costDust, formatIdleNumber(siloCosts.resources)); updateText(siloEls.costMetal, formatIdleNumber(siloCosts.metal)); const nextDustCap = BASE_DUST_CAPACITY + ((siloLevel + 1) * SILO_DUST_CAPACITY_PER_LEVEL); const nextMetalCap = BASE_METAL_CAPACITY + ((siloLevel + 1) * SILO_METAL_CAPACITY_PER_LEVEL); setTooltip(siloEls.button, `Level ${siloLevel + 1}: Max Staub ${formatIdleNumber(nextDustCap)}, Max Metall ${formatIdleNumber(nextMetalCap)}. Kosten: ${formatIdleNumber(siloCosts.resources)} 🌙, ${formatIdleNumber(siloCosts.metal)} 🔩`); if (siloEls.button && !siloEls.button.querySelector('#silo-cost-dust')) { siloEls.button.innerHTML = `Kosten: <span id="silo-cost-dust" class="num">${formatIdleNumber(siloCosts.resources)}</span> 🌙, <span id="silo-cost-metal" class="num">${formatIdleNumber(siloCosts.metal)}</span> 🔩`; } } }
         function updateDefenseTab(currentResources, currentEnergy, currentMetal) { const updateDefenseCard = (key, costResKey, costIcon, effectDescFunc) => { const els = upgradeElements[key]; if (!els || !els.button) return; const levelProp = `${key}Level`, baseCostProp = `${key}BaseCost`, multiplierProp = `${key}CostMultiplier`; const level = getStateNum(levelProp); const cost = calculateDefenseUpgradeCost(baseCostProp, multiplierProp, level); const canAfford = getStateNum(costResKey) >= cost; updateButtonState(els.button, canAfford); updateText(els.level, level); let effectText = effectDescFunc ? effectDescFunc(level + 1) : `Level ${level + 1}`; if (els.effect) { updateText(els.effect, (Math.min(90, level * SHIELD_COST_REDUCTION_PER_LEVEL * 100)).toFixed(0)); } if (els.damage) { updateText(els.damage, formatIdleNumber(calculateTurretDPS(), 1)); } setTooltip(els.button, `${effectText} Kosten: ${formatIdleNumber(cost)} ${costIcon}`); const costSpan = els.button.querySelector('.num'); if (costSpan) { updateText(costSpan, formatIdleNumber(cost)); } else { els.button.innerHTML = `Kosten: <span class="num">${formatIdleNumber(cost)}</span> ${costIcon}`; } }; const shieldDesc = (lvl) => `Level ${lvl}: Reduziert Kosten um ${(Math.min(90, lvl * SHIELD_COST_REDUCTION_PER_LEVEL * 100)).toFixed(0)}%.`; const turretDesc = (lvl) => `Level ${lvl}: Verursacht ${formatIdleNumber(lvl * TURRET_DAMAGE_PER_LEVEL, 1)} Schaden/Sek.`; updateDefenseCard('shield', 'energy', '⚡', shieldDesc); updateDefenseCard('turret', 'energy', '⚡', turretDesc); }
         function updateShipyardTab(currentResources, currentEnergy, currentMetal) { Object.values(SHIPS).forEach(ship => { const cardElement = document.getElementById(`shipyard-${ship.id}`); const lockedElement = document.getElementById(`shipyard-${ship.id}-locked`); const countElement = document.getElementById(ship.countElementId); const buttonElement = document.getElementById(ship.buildButtonId); const researchComplete = gameState.research?.[ship.requiresResearch] || false; if (cardElement) cardElement.classList.toggle('hidden', !researchComplete); if (lockedElement) lockedElement.classList.toggle('hidden', researchComplete); if (researchComplete) { updateText(countElement, formatIdleNumber(gameState.ships?.[ship.id] || 0, 0)); let canAfford = true; let costString = ""; let costStringTitle = ""; Object.entries(ship.cost).forEach(([resource, amount]) => { if (getStateNum(resource) < amount) canAfford = false; const icon = resource === 'resources' ? '🌙' : (resource === 'energy' ? '⚡' : '🔩'); const formattedAmount = formatIdleNumber(amount); costString += `${formattedAmount} ${icon} `; costStringTitle += `${formattedAmount} ${icon}, `; const costEl = document.getElementById(ship[`costElementId${resource.charAt(0).toUpperCase() + resource.slice(1)}`]); if(costEl) updateText(costEl, formattedAmount); else if(resource === 'metal' && document.getElementById(ship.costElementId)) updateText(document.getElementById(ship.costElementId), formattedAmount); }); updateButtonState(buttonElement, canAfford); if (buttonElement) { buttonElement.innerHTML = `Bauen (Kosten: <span class="num">${costString.trim()}</span>)`; setTooltip(buttonElement, `Baut ${ship.name}. Kosten: ${costStringTitle.slice(0,-2)}`); } } }); }
         function updateResearchTab(currentResources, currentEnergy, currentMetal) { Object.values(RESEARCH).forEach(researchItem => { const statusElement = document.getElementById(researchItem.statusElementId); const buttonElement = document.getElementById(researchItem.buttonElementId); const isResearched = gameState.research?.[researchItem.id] || false; if (statusElement) { updateText(statusElement, isResearched ? "Erforscht ✔️" : "Nicht erforscht"); statusElement.classList.toggle('text-green-400', isResearched); statusElement.classList.toggle('text-gray-400', !isResearched); } if (buttonElement) { if (isResearched) { buttonElement.disabled = true; buttonElement.innerHTML = 'Erforscht'; buttonElement.classList.add('bg-gray-500', 'hover:bg-gray-500'); buttonElement.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'affordable-highlight'); setTooltip(buttonElement, "Bereits erforscht."); } else { let canAfford = true; let costString = ""; let costStringTitle = ""; Object.entries(researchItem.cost).forEach(([resource, amount]) => { if (getStateNum(resource) < amount) canAfford = false; const icon = resource === 'resources' ? '🌙' : (resource === 'energy' ? '⚡' : '🔩'); const formattedAmount = formatIdleNumber(amount); costString += `${formattedAmount} ${icon} `; costStringTitle += `${formattedAmount} ${icon}, `; const costEl = document.getElementById(researchItem[`costElementId${resource.charAt(0).toUpperCase() + resource.slice(1)}`]); if(costEl) updateText(costEl, formattedAmount); else if(resource === 'resources' && document.getElementById(researchItem.costElementId)) updateText(document.getElementById(researchItem.costElementId), formattedAmount); }); updateButtonState(buttonElement, canAfford); buttonElement.innerHTML = `Erforschen (Kosten: <span class="num">${costString.trim()}</span>)`; setTooltip(buttonElement, `${researchItem.description} Kosten: ${costStringTitle.slice(0,-2)}`); buttonElement.classList.remove('bg-gray-500', 'hover:bg-gray-500'); buttonElement.classList.add('bg-purple-600', 'hover:bg-purple-700'); } } }); }
         function updatePlanetsTab(currentResources, currentEnergy, currentMetal) { if (!planetListContainer) return; Object.keys(PLANETS).forEach(planetId => { if (planetId === 'moon') return; const planetData = PLANETS[planetId]; const actionContainer = document.getElementById(`planet-${planetId}-action`); if (!actionContainer) return; const isColonized = gameState.colonizedPlanets?.[planetId] || false; if (isColonized) { actionContainer.innerHTML = `<span class="text-green-400 font-semibold w-full sm:w-auto text-center block sm:inline">Kolonisiert (+${(COLONY_PRODUCTION_BONUS * 100).toFixed(0)}% 🌙 Prod.)</span>`; } else { const cost = planetData.cost; const canAfford = currentResources >= cost; const colonyShipResearched = gameState.research?.colonizationTech || false; const hasColonyShip = getStateNum('ships', {}).colony > 0; const canColonize = canAfford && colonyShipResearched && hasColonyShip; let button = actionContainer.querySelector('button'); if (!button) { button = document.createElement('button'); button.id = `colonize-${planetId}`; button.className = 'bg-orange-600 hover:bg-orange-700 text-white text-sm font-bold py-2 px-3 rounded transition w-full sm:w-auto'; button.addEventListener('click', () => colonizePlanet(planetId)); actionContainer.innerHTML = ''; actionContainer.appendChild(button); } updateButtonState(button, canColonize); button.classList.toggle('opacity-60', !canColonize); button.classList.toggle('cursor-not-allowed', !canColonize); let buttonText = `Kolonisieren (Kosten: ${formatIdleNumber(cost)} <span class="text-yellow-300">🌙</span>`; let titleText = `Kolonisiert ${planetData.name}. Kosten: ${formatIdleNumber(cost)} 🌙.`; if (!colonyShipResearched) { buttonText += ` | Forschung benötigt)`; titleText += " Forschung 'Kolonisationstechnologie' benötigt."; } else if (!hasColonyShip) { buttonText += ` | Kolonieschiff 🛰️ benötigt)`; titleText += " Kolonieschiff benötigt.";} else { buttonText += `)`; } button.innerHTML = buttonText; setTooltip(button, titleText); } }); }
         function updateTradeTab(currentResources, currentEnergy, currentMetal) { const dustCostEnergy = 1000; const energyGainTrade = 100; const canAffordDustTrade = currentResources >= dustCostEnergy; const hasEnergyCapacity = currentEnergy + energyGainTrade <= calculateEnergyCapacity(); if (tradeDustForEnergyButton) { updateButtonState(tradeDustForEnergyButton, canAffordDustTrade && hasEnergyCapacity); let title = ""; if(!hasEnergyCapacity && canAffordDustTrade) title = "Nicht genug Energiekapazität!"; else if (!canAffordDustTrade) title = "Nicht genug Mondstaub!"; setTooltip(tradeDustForEnergyButton, title); } const energyCostMetal = 500; const metalGainTrade = 50; const canAffordEnergyTrade = currentEnergy >= energyCostMetal; const hasMetalCapacity = currentMetal + metalGainTrade <= calculateMetalCapacity(); if (tradeEnergyForMetalButton) { updateButtonState(tradeEnergyForMetalButton, canAffordEnergyTrade && hasMetalCapacity); let title = ""; if(!hasMetalCapacity && canAffordEnergyTrade) title = "Nicht genug Metallkapazität!"; else if (!canAffordEnergyTrade) title = "Nicht genug Energie!"; setTooltip(tradeEnergyForMetalButton, title); } }
         function updateStatsTab() { const playTimeSeconds = (Date.now() - getStateNum('startTime', Date.now())) / 1000; updateText(statTotalResources, formatIdleNumber(getStateNum('totalResourcesCollected') + getStateNum('resources'))); updateText(statTotalEnergy, formatIdleNumber(getStateNum('totalEnergyGenerated') + getStateNum('energy'))); updateText(statTotalMetal, formatIdleNumber(getStateNum('totalMetalGenerated') + getStateNum('metal'))); updateText(statPopulation, formatIdleNumber(getStateNum('population'), 0)); updateText(statShipTransport, formatIdleNumber(gameState.ships?.transport || 0, 0)); updateText(statShipFighter, formatIdleNumber(gameState.ships?.fighter || 0, 0)); updateText(statShipColony, formatIdleNumber(gameState.ships?.colony || 0, 0)); updateText(statTotalClicks, formatIdleNumber(getStateNum('totalManualClicks'), 0)); updateText(statThreatsDefeated, formatIdleNumber(getStateNum('threatsDefeated'), 0)); updateText(statPlayTime, formatTime(playTimeSeconds)); updateText(statMoonCrystals, formatIdleNumber(getStateNum('moonCrystals'))); updateText(statColonizedPlanets, formatIdleNumber(countColonizedPlanets(), 0)); updateText(statResearchCompleted, formatIdleNumber(countCompletedResearch(), 0)); }
         function updatePrestigeTab(currentResources) { const prestigeReq = getPrestigeRequirement(); const potentialNewCrystals = calculatePotentialNewCrystals(); const canAffordPrestige = currentResources >= prestigeReq; const canPrestigeNow = canAffordPrestige && (potentialNewCrystals > 0); updateText(prestigeCurrentCrystals, formatIdleNumber(getStateNum('moonCrystals'))); updateText(prestigeNextCrystals, formatIdleNumber(potentialNewCrystals)); updateText(prestigeRequirementElement, formatIdleNumber(prestigeReq)); updateButtonState(prestigeButton, canPrestigeNow); if (prestigeWarning) prestigeWarning.classList.toggle('hidden', canPrestigeNow); if(prestigeButton) { let title = `Prestige für ${formatIdleNumber(potentialNewCrystals)} Kristalle ✨. `; if(!canAffordPrestige) title += `Benötigt ${formatIdleNumber(prestigeReq)} 🌙.`; else if (potentialNewCrystals <= 0) title += `Keine neuen Kristalle zu gewinnen.`; else title += `Setzt Fortschritt zurück (außer Kristalle, Forschung, Kolonien).`; setTooltip(prestigeButton, title); } const progressPercent = prestigeReq > 0 ? Math.min(100, (currentResources / prestigeReq) * 100) : 0; if (prestigeProgressBarElement) prestigeProgressBarElement.style.width = `${progressPercent}%`; updateText(prestigeProgressPercentElement, `${progressPercent.toFixed(0)}%`); }
         function updateLeaderboardTab() { updateText(leaderboardPlayerRank, formatIdleNumber(getStateNum('moonCrystals'))); }
         function updateSettingsTab() { /* Derzeit keine dynamischen Updates nötig */ }

         // --- Event Listeners ---
         function setupEventListeners() {
             console.log("Setting up event listeners...");
             manualCollectButton?.addEventListener('click', () => {
                 const amount = calculateManualCollectAmount();
                 const currentRes = getStateNum('resources');
                 const capacity = calculateResourceCapacity();
                 const gain = Math.min(amount, Math.max(0, capacity - currentRes));
                 if (gain > 0) {
                     gameState.resources = currentRes + gain;
                     gameState.totalResourcesCollected = getStateNum('totalResourcesCollected') + gain;
                 }
                 gameState.totalManualClicks = getStateNum('totalManualClicks') + 1;
                 triggerAnimation(resourceCountElement, 'pulse-once');

                 // Particle Effect Logic
                 const rect = manualCollectButton.getBoundingClientRect();
                 const buttonCenterX = rect.left + rect.width / 2 + window.scrollX; // Berücksichtige Scroll-Position
                 const buttonCenterY = rect.top + rect.height / 2 + window.scrollY; // Berücksichtige Scroll-Position
                 const particleCount = 15; // Anzahl Partikel

                 for (let i = 0; i < particleCount; i++) {
                     const particle = document.createElement('div');
                     particle.classList.add('particle');
                     document.body.appendChild(particle);

                     // Startposition Mitte des Buttons + kleiner zufälliger Offset
                     const initialX = buttonCenterX + (Math.random() - 0.5) * rect.width * 0.8;
                     const initialY = buttonCenterY + (Math.random() - 0.5) * rect.height * 0.8;
                     particle.style.left = `${initialX}px`;
                     particle.style.top = `${initialY}px`;

                     // Zufällige Animationsverzögerung für gestaffelten Effekt
                     particle.style.animationDelay = `${Math.random() * 0.1}s`;

                     // Zufällige Flugbahn über CSS Custom Properties
                     const angle = Math.random() * Math.PI * 2; // Zufällige Richtung
                     const distance = Math.random() * 50 + 25; // Zufällige Distanz
                     const moveX = Math.cos(angle) * distance;
                     const moveY = Math.sin(angle) * distance - 60; // Eher nach oben (-60)

                     particle.style.setProperty('--translateX', `${moveX}px`);
                     particle.style.setProperty('--translateY', `${moveY}px`);

                     particle.addEventListener('animationend', () => {
                          if (particle.parentNode) {
                             particle.parentNode.removeChild(particle);
                          }
                     }, { once: true }); // Wichtig: Event Listener nur einmal ausführen
                 }

                 if (currentRes >= capacity && gain <= 0) {
                     showToast("Mondstaub-Lager ist voll!", "warning", 2000);
                 }
                 updateUI();
             });

             // --- (Restliche Event Listener wie zuvor, inkl. Settings Buttons) ---
             function addUpgradeListener(upgradeKey, costResource) { const elements = upgradeElements[upgradeKey]; if (!elements || !elements.button) return; elements.button.addEventListener('click', () => { const levelProp = `${upgradeKey}Level`, baseCostProp = `${upgradeKey}BaseCost`, multiplierProp = `${upgradeKey}CostMultiplier`; const currentLevel = getStateNum(levelProp); let cost; if (upgradeKey === 'shield' || upgradeKey === 'turret') { cost = calculateDefenseUpgradeCost(baseCostProp, multiplierProp, currentLevel); } else { cost = calculateCost(baseCostProp, multiplierProp, currentLevel); } const currentRes = getStateNum(costResource); if (currentRes >= cost) { gameState[costResource] = currentRes - cost; gameState[levelProp] = currentLevel + 1; triggerAnimation(elements.button.closest('.upgrade-card') || elements.button, 'flash-upgrade'); updateUI(); } }); }
             function addMultiResourceUpgradeListener(upgradeKey, costStateKeys) { const elements = upgradeElements[upgradeKey]; if (!elements || !elements.button) return; elements.button.addEventListener('click', () => { const levelProp = `${upgradeKey}Level`; const currentLevel = getStateNum(levelProp); const costs = calculateMultiResourceCost({ resources: gameState.siloBaseCostDust, metal: gameState.siloBaseCostMetal }, { resources: gameState.siloCostMultiplier, metal: gameState.siloCostMultiplier }, currentLevel); let canAfford = true; for (const resource in costs) { if (getStateNum(resource) < costs[resource]) { canAfford = false; break; } } if (canAfford) { for (const resource in costs) { gameState[resource] = getStateNum(resource) - costs[resource]; } gameState[levelProp] = currentLevel + 1; triggerAnimation(elements.button.closest('.upgrade-card') || elements.button, 'flash-upgrade'); updateUI(); } else { showToast(`Nicht genug Ressourcen für Silo-Upgrade!`, 'warning'); } }); }
             addUpgradeListener('collector', 'resources'); addUpgradeListener('rover', 'resources'); addUpgradeListener('efficiency', 'resources'); addUpgradeListener('clickPower', 'resources'); addUpgradeListener('clickMultiplier', 'resources'); addUpgradeListener('generator', 'resources'); addUpgradeListener('storage', 'metal'); addUpgradeListener('mining', 'resources'); addUpgradeListener('housing', 'metal'); addUpgradeListener('shield', 'energy'); addUpgradeListener('turret', 'energy'); addMultiResourceUpgradeListener('silo', ['resources', 'metal']);
             Object.values(RESEARCH).forEach(researchItem => { document.getElementById(researchItem.buttonElementId)?.addEventListener('click', () => buyResearch(researchItem.id)); });
             Object.values(SHIPS).forEach(ship => { document.getElementById(ship.buildButtonId)?.addEventListener('click', () => buildShip(ship.id)); });
             tradeDustForEnergyButton?.addEventListener('click', () => tradeResource('resources', 1000, 'energy', 100)); tradeEnergyForMetalButton?.addEventListener('click', () => tradeResource('energy', 500, 'metal', 50));
             burgerButton?.addEventListener('click', (e) => { e.stopPropagation(); burgerMenu?.classList.toggle('active'); burgerMenuOverlay?.classList.toggle('active'); }); burgerMenuOverlay?.addEventListener('click', () => { burgerMenu?.classList.remove('active'); burgerMenuOverlay?.classList.remove('active'); }); menuItems?.forEach(item => { item?.addEventListener('click', () => { const targetTabId = item.dataset.tab; if (!targetTabId || targetTabId === activeTab) { burgerMenu?.classList.remove('active'); burgerMenuOverlay?.classList.remove('active'); return; } activeTab = targetTabId; menuItems.forEach(mi => mi?.classList.remove('active')); item.classList.add('active'); tabContents.forEach(content => { if (content) { const isTarget = content.id === `${targetTabId}-tab`; content.style.display = isTarget ? 'block' : 'none'; content.classList.toggle('active', isTarget); content.classList.remove('fadeInContent'); if (isTarget) requestAnimationFrame(() => { if (content.id === `${activeTab}-tab`) content.classList.add('fadeInContent'); }); } }); burgerMenu?.classList.remove('active'); burgerMenuOverlay?.classList.remove('active'); updateUI(); }); });
             prestigeButton?.addEventListener('click', () => { const prestigeReq = getPrestigeRequirement(); const potentialNewCrystals = calculatePotentialNewCrystals(); if (getStateNum('resources') >= prestigeReq && potentialNewCrystals > 0) { if (confirm(`Prestige für ${formatIdleNumber(potentialNewCrystals)} Kristalle ✨? Upgrades, Staub 🌙, Energie ⚡, Metall 🔩, Bevölkerung 👨‍👩‍👧‍👦, Schiffe 🚀, Silos 📦 werden zurückgesetzt. Kolonien, Forschung & Kristalle bleiben.`)) { performPrestige(potentialNewCrystals); saveGame(); } } else { console.warn("Prestige conditions not met."); updateUI(); } });
             resetButton?.addEventListener('click', () => { if (confirm('WARNUNG: Gesamten Spielstand inkl. Kristalle & Kolonien löschen? Dies kann nicht rückgängig gemacht werden!')) { localStorage.removeItem(SAVE_KEY); gameState = getDefaultGameState(); saveGame(); window.location.reload(); } });
             const openPasswordModal = () => { if (adminPasswordModalOverlay) { adminPasswordInput.value = ''; passwordErrorMessage?.classList.add('hidden'); adminPasswordModalOverlay.classList.add('active'); adminPasswordInput.focus(); }}; adminMenuButtonFooter?.addEventListener('click', openPasswordModal); closePasswordModalButton?.addEventListener('click', () => adminPasswordModalOverlay?.classList.remove('active')); adminPasswordModalOverlay?.addEventListener('click', (event) => { if (event.target === adminPasswordModalOverlay) adminPasswordModalOverlay.classList.remove('active'); }); submitPasswordButton?.addEventListener('click', () => { if (adminPasswordInput?.value === ADMIN_PASSWORD) { adminPasswordModalOverlay?.classList.remove('active'); adminControlsModalOverlay?.classList.add('active'); } else { if(passwordErrorMessage) passwordErrorMessage.classList.remove('hidden'); if(adminPasswordInput) adminPasswordInput.value = ''; triggerAnimation(adminPasswordModalOverlay?.querySelector('.modal-content'), 'shake'); } }); adminPasswordInput?.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); submitPasswordButton?.click(); } }); closeAdminControlsModalButton?.addEventListener('click', () => adminControlsModalOverlay?.classList.remove('active')); adminControlsModalOverlay?.addEventListener('click', (event) => { if (event.target === adminControlsModalOverlay) adminControlsModalOverlay.classList.remove('active'); }); adminAddDustButton?.addEventListener('click', () => { gameState.resources = Math.min(calculateResourceCapacity(), getStateNum('resources') + 1e6); updateUI(); }); adminAddEnergyButton?.addEventListener('click', () => { gameState.energy = Math.min(calculateEnergyCapacity(), getStateNum('energy') + 1e6); updateUI(); }); adminAddMetalButton?.addEventListener('click', () => { gameState.metal = Math.min(calculateMetalCapacity(), getStateNum('metal') + 1e6); updateUI(); }); adminAddCrystalsButton?.addEventListener('click', () => { gameState.moonCrystals = getStateNum('moonCrystals') + 100; updateUI(); });
             notificationButton?.addEventListener('click', () => { if (gameState.activeThreat) { const cost = calculateThreatCost(); const toastMessage = `🚨 ${gameState.activeThreat.description}<br>Stärke: <span class="threat-health-display">${formatIdleNumber(gameState.activeThreat.currentHealth)}</span><br><button onclick="neutralizeThreatFromToast(this)" data-cost="${cost}" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-1 px-2 rounded text-xs">Abwehren (${formatIdleNumber(cost)} ⚡)</button>`; showToast(toastMessage, 'threat', 15000); } else { showToast("Keine neuen Benachrichtigungen.", 'info', 3000); } });
             changelogButtonFooter?.addEventListener('click', () => changelogModalOverlay?.classList.add('active')); closeChangelogModalButton?.addEventListener('click', () => changelogModalOverlay?.classList.remove('active')); changelogModalOverlay?.addEventListener('click', (event) => { if (event.target === changelogModalOverlay) changelogModalOverlay.classList.remove('active'); });
             manualSaveButton?.addEventListener('click', saveGame); // NEU
             manualLoadButton?.addEventListener('click', () => window.location.reload()); // NEU
             console.log("Event listeners setup complete.");
         }

         // --- Core Game Functions ---
         function checkThreat() { if (gameState.activeThreat) return; const chance = THREAT_BASE_CHANCE + getStateNum('moonCrystals') * 0.005; if (Math.random() < chance) spawnThreat(); }
         function spawnThreat() { const threatTypes = [ { id: "asteroid", name: "Asteroidenschwarm", description: "Ein dichter Asteroidenschwarm nähert sich!" }, { id: "pirates", name: "Weltraumpiraten", description: "Piraten versuchen zu plündern!" }, { id: "anomaly", name: "Energieanomalie", description: "Eine seltsame Anomalie stört!" },]; const randomType = threatTypes[Math.floor(Math.random() * threatTypes.length)]; const health = Math.floor(THREAT_BASE_HEALTH * Math.pow(THREAT_HEALTH_SCALE, getStateNum('moonCrystals'))); gameState.activeThreat = { id: randomType.id, description: randomType.description, maxHealth: health, currentHealth: health, }; const cost = calculateThreatCost(); const toastMessage = `🚨 ${randomType.description}<br>Stärke: <span class="threat-health-display">${formatIdleNumber(health)}</span><br><button onclick="neutralizeThreatFromToast(this)" data-cost="${cost}" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-1 px-2 rounded text-xs">Abwehren (${formatIdleNumber(cost)} ⚡)</button>`; showToast(toastMessage, 'threat', 15000); updateUI(); }
         function resolveThreat(defeated) { if (!gameState.activeThreat) return; const threatName = gameState.activeThreat.description; gameState.activeThreat = null; if (defeated) { gameState.threatsDefeated = getStateNum('threatsDefeated') + 1; showToast(`Bedrohung "${threatName.substring(0,30)}..." abgewehrt!`, 'success'); } else { showToast(`Bedrohung "${threatName.substring(0,30)}..." entkommen.`, 'warning'); } updateUI(); }
         function neutralizeThreatFromToast(buttonElement) { if (!gameState.activeThreat) { const toast = buttonElement.closest('.toast'); if (toast) removeToast(toast); return; } const cost = parseInt(buttonElement.dataset.cost, 10); const currentEnergy = getStateNum('energy'); if (currentEnergy >= cost) { gameState.energy = currentEnergy - cost; const damage = (gameState.activeThreat.maxHealth || THREAT_BASE_HEALTH) * 0.25; gameState.activeThreat.currentHealth = Math.max(0, (gameState.activeThreat.currentHealth || 0) - damage); if (gameState.activeThreat.currentHealth <= 0) { resolveThreat(true); const toast = buttonElement.closest('.toast'); if (toast) removeToast(toast); } else { const toast = buttonElement.closest('.toast'); const healthDisplay = toast?.querySelector('.threat-health-display'); if (healthDisplay) healthDisplay.textContent = formatIdleNumber(gameState.activeThreat.currentHealth); const newCost = calculateThreatCost(); buttonElement.dataset.cost = newCost; buttonElement.innerHTML = `Abwehren (${formatIdleNumber(newCost)} ⚡)`; buttonElement.disabled = getStateNum('energy') < newCost; triggerAnimation(toast, 'pulse-once'); } updateUI(); } else { showToast("Nicht genug Energie ⚡!", 'warning', 3000); } }
         function handleThreatDamage(deltaTimeSeconds) { if (!gameState.activeThreat || deltaTimeSeconds <= 0) return; const turretDPS = calculateTurretDPS(); if (turretDPS <= 0) return; const damageDealt = turretDPS * deltaTimeSeconds; gameState.activeThreat.currentHealth = Math.max(0, (gameState.activeThreat.currentHealth || 0) - damageDealt); const activeThreatToasts = toastContainer?.querySelectorAll('.toast.toast-threat'); activeThreatToasts?.forEach(toast => { const healthDisplay = toast.querySelector('.threat-health-display'); const currentFormattedHealth = formatIdleNumber(gameState.activeThreat.currentHealth); if (healthDisplay && healthDisplay.textContent !== currentFormattedHealth) healthDisplay.textContent = currentFormattedHealth; }); if (gameState.activeThreat.currentHealth <= 0) { activeThreatToasts?.forEach(toast => removeToast(toast)); resolveThreat(true); } }
         function performPrestige(crystalsGained) { const currentCrystals = getStateNum('moonCrystals'); const totalRes = getStateNum('totalResourcesCollected') + getStateNum('resources'); const totalNrg = getStateNum('totalEnergyGenerated') + getStateNum('energy'); const totalMet = getStateNum('totalMetalGenerated') + getStateNum('metal'); const totalClicks = getStateNum('totalManualClicks'); const threatsDefeated = getStateNum('threatsDefeated'); const startTime = getStateNum('startTime', Date.now()); const colonized = { ...(gameState.colonizedPlanets || {}) }; const research = { ...(gameState.research || {}) }; const newState = getDefaultGameState(); newState.moonCrystals = currentCrystals + crystalsGained; newState.totalResourcesCollected = totalRes; newState.totalEnergyGenerated = totalNrg; newState.totalMetalGenerated = totalMet; newState.totalManualClicks = totalClicks; newState.threatsDefeated = threatsDefeated; newState.startTime = startTime; newState.colonizedPlanets = colonized; newState.research = research; newState.lastUpdate = Date.now(); gameState = newState; activeTab = 'overview'; menuItems?.forEach(item => item?.classList.toggle('active', item.dataset.tab === activeTab)); tabContents.forEach(content => { if(content) { const isActive = content.id === `${activeTab}-tab`; content.style.display = isActive ? 'block' : 'none'; content.classList.toggle('active', isActive); } }); updateUI(); showToast(`Prestige erfolgreich! +${formatIdleNumber(crystalsGained)} Kristalle ✨ erhalten!`, 'success', 6000); }
         function buyResearch(researchId) { const researchItem = RESEARCH[researchId]; if (!researchItem || gameState.research?.[researchId]) return; let canAfford = true; Object.entries(researchItem.cost).forEach(([res, amount]) => { if (getStateNum(res) < amount) canAfford = false; }); if (canAfford) { Object.entries(researchItem.cost).forEach(([res, amount]) => { gameState[res] = getStateNum(res) - amount; }); if (!gameState.research) gameState.research = {}; gameState.research[researchId] = true; showToast(`${researchItem.name} erforscht!`, 'success'); const btn = document.getElementById(researchItem.buttonElementId); triggerAnimation(btn?.closest('.research-card'), 'flash-upgrade'); updateUI(); saveGame(); } else { showToast(`Nicht genug Ressourcen für ${researchItem.name}`, 'warning'); } }
         function buildShip(shipId) { const shipData = SHIPS[shipId]; if (!shipData || !gameState.research?.[shipData.requiresResearch]) { showToast(`Forschung benötigt oder Schiff ungültig!`, 'warning'); return; } let canAfford = true; Object.entries(shipData.cost).forEach(([res, amount]) => { if (getStateNum(res) < amount) canAfford = false; }); if (canAfford) { Object.entries(shipData.cost).forEach(([res, amount]) => { gameState[res] = getStateNum(res) - amount; }); if (!gameState.ships) gameState.ships = {}; gameState.ships[shipId] = (gameState.ships[shipId] || 0) + 1; const btn = document.getElementById(shipData.buildButtonId); triggerAnimation(btn?.closest('.shipyard-card'), 'flash-upgrade'); showToast(`${shipData.name} ${shipData.icon} gebaut!`, 'success', 3000); updateUI(); } else { showToast(`Nicht genug Ressourcen für ${shipData.name}!`, 'warning'); } }
         function colonizePlanet(planetId) { const planetData = PLANETS[planetId]; if (!planetData || gameState.colonizedPlanets?.[planetId]) return; const colonyShipResearched = gameState.research?.colonizationTech || false; const hasColonyShip = getStateNum('ships', {}).colony > 0; if (!colonyShipResearched) { showToast(`Forschung "${RESEARCH.colonizationTech.name}" benötigt!`, 'warning'); return; } if (!hasColonyShip) { showToast(`Kein ${SHIPS.colony.name} ${SHIPS.colony.icon} verfügbar!`, 'warning'); return; } if (getStateNum('resources') >= planetData.cost) { gameState.resources = getStateNum('resources') - planetData.cost; gameState.ships.colony = getStateNum('ships', {}).colony - 1; if (!gameState.colonizedPlanets) gameState.colonizedPlanets = {}; gameState.colonizedPlanets[planetId] = true; showToast(`${planetData.name} erfolgreich kolonisiert!`, 'success'); triggerAnimation(document.getElementById(`planet-${planetId}-container`), 'flash-upgrade'); updateUI(); saveGame(); } else { showToast(`Nicht genug 🌙 zum Kolonisieren von ${planetData.name}!`, 'warning'); } }
         function tradeResource(resourceFrom, amountFrom, resourceTo, amountTo) { const currentFrom = getStateNum(resourceFrom); if (currentFrom >= amountFrom) { let capacityTo = Infinity; if (resourceTo === 'resources') capacityTo = calculateResourceCapacity(); else if (resourceTo === 'metal') capacityTo = calculateMetalCapacity(); else if (resourceTo === 'energy') capacityTo = calculateEnergyCapacity(); const currentTo = getStateNum(resourceTo); const gain = Math.min(amountTo, Math.max(0, capacityTo - currentTo)); if (gain <= 0 && amountTo > 0) { const iconTo = resourceTo === 'resources' ? '🌙' : (resourceTo === 'energy' ? '⚡' : '🔩'); showToast(`Lager für ${iconTo} ist voll! Handel nicht möglich.`, 'warning'); return; } gameState[resourceFrom] = currentFrom - amountFrom; gameState[resourceTo] = currentTo + gain; const elementFrom = resourceFrom === 'resources' ? resourceCountElement : (resourceFrom === 'energy' ? energyCountElement : metalCountElement); const elementTo = resourceTo === 'resources' ? resourceCountElement : (resourceTo === 'energy' ? energyCountElement : metalCountElement); triggerAnimation(elementFrom, 'pulse-once'); triggerAnimation(elementTo, 'pulse-once'); updateUI(); } else { const iconFrom = resourceFrom === 'resources' ? '🌙' : (resourceFrom === 'energy' ? '⚡' : '🔩'); showToast(`Nicht genug ${iconFrom} zum Tauschen!`, 'warning'); } }
         function gameLoop() { const now = Date.now(); const lastUpdate = getStateNum('lastUpdate', now); const deltaTime = Math.max(0, (now - lastUpdate) / 1000); if (deltaTime > 0) { const resourceGain = calculateResourceRate() * deltaTime; const energyGain = calculateEnergyRate() * deltaTime; const metalGain = calculateMetalRate() * deltaTime; const populationGain = calculatePopulationRate() * deltaTime; const currentRes = getStateNum('resources'); const resCapacity = calculateResourceCapacity(); const actualResourceGain = Math.min(resourceGain, Math.max(0, resCapacity - currentRes)); if (actualResourceGain > 0) { gameState.resources = currentRes + actualResourceGain; gameState.totalResourcesCollected = getStateNum('totalResourcesCollected') + actualResourceGain; } const currentNrg = getStateNum('energy'); const energyCapacity = calculateEnergyCapacity(); const actualEnergyGain = Math.min(energyGain, Math.max(0, energyCapacity - currentNrg)); if (actualEnergyGain > 0) { gameState.energy = currentNrg + actualEnergyGain; gameState.totalEnergyGenerated = getStateNum('totalEnergyGenerated') + energyGain; } const currentMet = getStateNum('metal'); const metalCapacity = calculateMetalCapacity(); const actualMetalGain = Math.min(metalGain, Math.max(0, metalCapacity - currentMet)); if (actualMetalGain > 0) { gameState.metal = currentMet + actualMetalGain; gameState.totalMetalGenerated = getStateNum('totalMetalGenerated') + actualMetalGain; } const currentPop = getStateNum('population'); const popCapacity = calculatePopulationCapacity(); const actualOfflinePopulationGain = Math.min(populationGain, Math.max(0, popCapacity - currentPop)); if (actualOfflinePopulationGain > 0) { gameState.population = currentPop + actualOfflinePopulationGain; } handleThreatDamage(deltaTime); } gameState.lastUpdate = now; updateUI(); }

         // --- Persistence (Save/Load) ---
         function saveGame() { try { gameState.lastUpdate = Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(gameState)); showToast("Spiel gespeichert!", 'success', 1500); } catch (error) { console.error("Save failed:", error); showToast("Speichern fehlgeschlagen!", "warning"); } }
         function loadGame() { const savedState = localStorage.getItem(SAVE_KEY); const defaultState = getDefaultGameState(); if (savedState) { try { const loadedState = JSON.parse(savedState); gameState = { ...defaultState, ...loadedState }; gameState.colonizedPlanets = { ...(defaultState.colonizedPlanets || {}), ...(loadedState.colonizedPlanets || {}) }; gameState.research = { ...(defaultState.research || {}), ...(loadedState.research || {}) }; gameState.ships = { ...(defaultState.ships || {}), ...(loadedState.ships || {}) }; gameState.activeThreat = loadedState.activeThreat || null; const now = Date.now(); const lastUpdate = getStateNum('lastUpdate', now); const timeDiffSeconds = Math.max(0, (now - lastUpdate) / 1000); if (timeDiffSeconds > 1) { const offlineResourceRate = calculateResourceRate(); const offlineEnergyRate = calculateEnergyRate(); const offlineMetalRate = calculateMetalRate(); const offlinePopulationRate = calculatePopulationRate(); const offlineResourceGains = offlineResourceRate * timeDiffSeconds; const offlineEnergyGains = offlineEnergyRate * timeDiffSeconds; const offlineMetalGains = offlineMetalRate * timeDiffSeconds; const offlinePopulationGainsPotential = offlinePopulationRate * timeDiffSeconds; let offlineThreatDefeated = false; let offlineThreatDamage = 0; if (gameState.activeThreat) { const initialThreatHealth = gameState.activeThreat.currentHealth || 0; const offlineTurretDPS = calculateTurretDPS(); offlineThreatDamage = offlineTurretDPS * timeDiffSeconds; gameState.activeThreat.currentHealth = Math.max(0, initialThreatHealth - offlineThreatDamage); if (gameState.activeThreat.currentHealth <= 0) offlineThreatDefeated = true; } const currentRes = getStateNum('resources'); const resCapacity = calculateResourceCapacity(); const actualOfflineResourceGain = Math.min(offlineResourceGains, Math.max(0, resCapacity - currentRes)); gameState.resources = currentRes + actualOfflineResourceGain; gameState.totalResourcesCollected = getStateNum('totalResourcesCollected') + actualOfflineResourceGain; const currentNrg = getStateNum('energy'); const energyCap = calculateEnergyCapacity(); const actualOfflineEnergyGain = Math.min(offlineEnergyGains, Math.max(0, energyCap - currentNrg)); gameState.energy = currentNrg + actualOfflineEnergyGain; gameState.totalEnergyGenerated = getStateNum('totalEnergyGenerated') + offlineEnergyGains; const currentMet = getStateNum('metal'); const metalCapacity = calculateMetalCapacity(); const actualOfflineMetalGain = Math.min(offlineMetalGains, Math.max(0, metalCapacity - currentMet)); gameState.metal = currentMet + actualOfflineMetalGain; gameState.totalMetalGenerated = getStateNum('totalMetalGenerated') + actualOfflineMetalGain; const currentPop = getStateNum('population'); const popCap = calculatePopulationCapacity(); const actualOfflinePopulationGain = Math.min(offlinePopulationGainsPotential, Math.max(0, popCap - currentPop)); gameState.population = currentPop + actualOfflinePopulationGain; let noticeText = `Willkommen zurück! Offline (${formatTime(timeDiffSeconds)}):<br><span class='font-bold text-yellow-300'>+${formatIdleNumber(actualOfflineResourceGain)}</span> 🌙 | <span class='font-bold text-cyan-300'>+${formatIdleNumber(actualOfflineEnergyGain)}</span>⚡ | <span class='font-bold text-slate-300'>+${formatIdleNumber(actualOfflineMetalGain)}</span> 🔩 | <span class='font-bold text-green-300'>+${formatIdleNumber(actualOfflinePopulationGain, 0)}</span> 👨‍👩‍👧‍👦`; if (offlineThreatDefeated) { noticeText += "<br><span class='font-bold text-green-400'>Bedrohung offline abgewehrt!</span>"; resolveThreat(true); } else if (gameState.activeThreat && offlineThreatDamage > 0) { noticeText += `<br><span class='font-bold text-red-400'>Bedrohung offline geschwächt! (${formatIdleNumber(gameState.activeThreat.currentHealth)})</span>`; } showToast(noticeText, 'info', 8000); } gameState.lastUpdate = now; } catch (error) { console.error("Load failed, resetting game:", error); localStorage.removeItem(SAVE_KEY); gameState = defaultState; gameState.lastUpdate = Date.now(); showToast("Fehler beim Laden. Spiel zurückgesetzt.", "warning", 7000); } } else { gameState = defaultState; gameState.lastUpdate = Date.now(); } gameState.resources = Number(gameState.resources) || 0; gameState.energy = Number(gameState.energy) || 0; gameState.metal = Number(gameState.metal) || 0; gameState.population = Number(gameState.population) || 0; gameState.moonCrystals = Number(gameState.moonCrystals) || 0; gameState.siloLevel = Number(gameState.siloLevel) || 0; if (!document.getElementById(`${activeTab}-tab`)) activeTab = 'overview'; updateUI(); }

         // --- Initialization ---
         function getDefaultGameState() {
             // *** HIER SIND DIE NOCHMALS ANGEPASSTEN KOSTEN ***
             return {
                 resources: 0, energy: 0, metal: 1, population: 0, lastUpdate: Date.now(),
                 collectorLevel: 0, collectorBaseCost: 10, collectorCostMultiplier: 1.12, collectorBaseIncrease: 1,
                 roverLevel: 0, roverBaseCost: 250, roverCostMultiplier: 1.15, roverBaseIncrease: 10,
                 efficiencyLevel: 0, efficiencyBaseCost: 100, efficiencyCostMultiplier: 1.75,
                 clickPowerLevel: 0, clickPowerBaseCost: 25, clickPowerCostMultiplier: 1.18, clickPowerBaseIncrease: 1,
                 clickMultiplierLevel: 0, clickMultiplierBaseCost: 500, clickMultiplierCostMultiplier: 1.6,
                 generatorLevel: 0, generatorBaseCost: 800, generatorCostMultiplier: 1.2, generatorBaseIncrease: 1,
                 storageLevel: 0, storageBaseCost: 200, storageCostMultiplier: 1.5,
                 miningLevel: 0,
                 miningBaseCost: 400, // NEUER WERT (war 500)
                 miningCostMultiplier: 1.22, // NEUER WERT (war 1.25)
                 miningBaseIncrease: 1,
                 housingLevel: 0, housingBaseCost: 100, housingCostMultiplier: 1.3, housingBaseIncrease: 0.1,
                 siloLevel: 0,
                 siloBaseCostDust: 300, // NEUER WERT (war 400)
                 siloBaseCostMetal: 60, // NEUER WERT (war 80)
                 siloCostMultiplier: 1.4, // NEUER WERT (war 1.45)
                 shieldLevel: 0, shieldBaseCost: 50, shieldCostMultiplier: 1.4,
                 turretLevel: 0, turretBaseCost: 100, turretCostMultiplier: 1.45,
                 moonCrystals: 0, prestigeRequirementBase: 1000000,
                 colonizedPlanets: {}, research: {}, ships: { transport: 0, fighter: 0, colony: 0 },
                 totalResourcesCollected: 0, totalEnergyGenerated: 0, totalMetalGenerated: 0, totalManualClicks: 0, threatsDefeated: 0,
                 startTime: Date.now(), activeThreat: null,
             };
         }
         function buildPlanetList() { if (!planetListContainer) return; planetListContainer.innerHTML = ''; Object.keys(PLANETS).forEach(planetId => { if (planetId === 'moon') return; const planetData = PLANETS[planetId]; const planetDiv = document.createElement('div'); planetDiv.id = `planet-${planetId}-container`; planetDiv.className = 'upgrade-card'; planetDiv.innerHTML = `<div class="text-left flex-grow"><p class="font-semibold text-lg">${planetData.name}</p><p class="text-sm text-gray-400">${planetData.description}</p></div><div id="planet-${planetId}-action" class="flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0"></div>`; planetListContainer.appendChild(planetDiv); }); }
         document.addEventListener('DOMContentLoaded', () => { console.log("DOM fully loaded. Initializing Idle Moons (v8.9c)..."); loadGame(); buildPlanetList(); setupEventListeners(); tabContents.forEach(content => { if (content) { const isActive = content.id === `${activeTab}-tab`; content.style.display = isActive ? 'block' : 'none'; content.classList.toggle('active', isActive); content.classList.remove('fadeInContent'); } }); menuItems?.forEach(item => { if (item) item.classList.toggle('active', item.dataset.tab === activeTab); }); setInterval(gameLoop, TICK_RATE_MS); setInterval(checkThreat, THREAT_CHECK_INTERVAL_MS); setInterval(saveGame, 15000); console.log("Idle Moons initialization complete (v8.9c)."); });

    </script>

</body>
</html>